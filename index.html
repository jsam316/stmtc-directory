<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>St Thomas MTC Salmiya - Church Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        html, body {
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        button, a, [role="button"], .clickable {
            touch-action: manipulation;
            cursor: pointer;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-content {
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { jsPDF } = window.jspdf;

        // ðŸ” ENCRYPTED GITHUB TOKEN CONFIGURATION ðŸ”
        // Token is encrypted with admin PIN for maximum security
        // Regular users CANNOT decrypt this (requires admin PIN)
        const ENCRYPTED_GITHUB_TOKEN = 'rBL68pX60Iws99pFkzYASAJlPpjQy2QEyrwchgXhjHq7nXvWJFeSMYzMakryOUBSZQKjtx0qyrTLK8DbItFDBPRepdHqPXCj/Raar/+FujBJ7GDY5NQaHzUOi10UyO2Zm3KE1VGwSds04XuhOE4ozuV4vgTTwEiG0E/r1cABiLa4I289HEkeicM=';
        const GITHUB_REPO = 'jsam316/stmtc-directory';
        const GITHUB_BRANCH = 'main';
        const GITHUB_FILE_PATH = 'data/families.json.enc';
        
        // Security Model:
        // - Token encrypted with AES-256-GCM using admin PIN
        // - Only admins with correct PIN can decrypt token
        // - Regular users with directory password CANNOT access GitHub
        // - Perfect privilege separation: View vs Edit
        
        // ENCRYPTION
        class DirectoryCrypto {
            constructor() {
                this.algorithm = 'AES-GCM';
                this.keyLength = 256;
                this.iterations = 100000;
            }
            async deriveKey(password, salt) {
                const encoder = new TextEncoder();
                const passwordKey = await crypto.subtle.importKey('raw', encoder.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
                return await crypto.subtle.deriveKey({name: 'PBKDF2', salt: salt, iterations: this.iterations, hash: 'SHA-256'}, passwordKey, {name: this.algorithm, length: this.keyLength}, false, ['encrypt', 'decrypt']);
            }
            async encrypt(data, password) {
                const encoder = new TextEncoder();
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await this.deriveKey(password, salt);
                const encrypted = await crypto.subtle.encrypt({name: this.algorithm, iv: iv}, key, encoder.encode(JSON.stringify(data)));
                const combined = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.byteLength);
                combined.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);
                return btoa(String.fromCharCode(...combined));
            }
            async decrypt(encryptedBase64, password) {
                try {
                    const combined = new Uint8Array(atob(encryptedBase64).split('').map(c => c.charCodeAt(0)));
                    const salt = combined.slice(0, 16);
                    const iv = combined.slice(16, 28);
                    const encrypted = combined.slice(28);
                    const key = await this.deriveKey(password, salt);
                    const decrypted = await crypto.subtle.decrypt({name: this.algorithm, iv: iv}, key, encrypted);
                    return JSON.parse(new TextDecoder().decode(decrypted));
                } catch (error) {
                    throw new Error('Incorrect password or corrupted data');
                }
            }
            async loadEncryptedFile() {
                const paths = ['data/families.json.enc', './data/families.json.enc', 'families.json.enc', './families.json.enc'];
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) return await response.text();
                    } catch (error) {}
                }
                throw new Error('FILE_NOT_FOUND');
            }
        }
        const directoryCrypto = new DirectoryCrypto();

        // PDF.js worker
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // GITHUB SYNC
        class GitHubSync {
            constructor() {
                this.token = null;
                this.repo = GITHUB_REPO;
                this.branch = GITHUB_BRANCH;
                this.filePath = GITHUB_FILE_PATH;
                this.loadConfig();
            }
            loadConfig() {
                try {
                    const config = localStorage.getItem('githubSyncConfig');
                    if (config) {
                        const parsed = JSON.parse(config);
                        this.token = parsed.token;
                        this.repo = parsed.repo;
                        this.branch = parsed.branch || 'main';
                        this.filePath = parsed.filePath || 'data/families.json.enc';
                    }
                } catch (error) { console.error('Failed to load GitHub config:', error); }
            }
            saveConfig(token, repo, branch = 'main', filePath = 'data/families.json.enc') {
                this.token = token;
                this.repo = repo;
                this.branch = branch;
                this.filePath = filePath;
                localStorage.setItem('githubSyncConfig', JSON.stringify({ token, repo, branch, filePath }));
                return true;
            }
            setDecryptedToken(token) {
                // Called after admin logs in with PIN
                this.token = token;
                console.log('âœ… GitHub token decrypted and ready');
            }
            isConfigured() { return !!(this.token && this.repo); }
            async testConnection() {
                if (!this.isConfigured()) throw new Error('GitHub not configured');
                const response = await fetch(`https://api.github.com/repos/${this.repo}`, {
                    headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!response.ok) throw new Error(response.status === 401 ? 'Invalid token' : 'Repository not found');
                return await response.json();
            }
            async getFileSHA() {
                try {
                    const response = await fetch(`https://api.github.com/repos/${this.repo}/contents/${this.filePath}?ref=${this.branch}`, {
                        headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return data.sha;
                    }
                    return null;
                } catch (error) { return null; }
            }
            async uploadData(encryptedData, commitMessage = null) {
                if (!this.isConfigured()) throw new Error('GitHub not configured');
                const sha = await this.getFileSHA();
                if (!commitMessage) {
                    const now = new Date();
                    commitMessage = `Updated directory - ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                }
                const body = { message: commitMessage, content: btoa(encryptedData), branch: this.branch };
                if (sha) body.sha = sha;
                const response = await fetch(`https://api.github.com/repos/${this.repo}/contents/${this.filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Upload failed');
                }
                return await response.json();
            }
        }
        const githubSync = new GitHubSync();

        // PIN MANAGER
        class PinManager {
            constructor() { this.defaultPin = '753159'; }
            getPin() { return localStorage.getItem('adminPin') || this.defaultPin; }
            setPin(newPin) { localStorage.setItem('adminPin', newPin); }
            verifyPin(pin) { return pin === this.getPin(); }
        }
        const pinManager = new PinManager();

        // HELPERS
        function downloadFile(content, filename, mimeType = 'text/plain') {
            try {
                const blob = new Blob([content], {type: mimeType});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                return true;
            } catch (error) {
                console.error('Download failed:', error);
                return false;
            }
        }

        function exportToPDF(families) {
            try {
                const doc = new jsPDF();
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('St Thomas MTC Salmiya, Kuwait', margin, yPos);
                yPos += 10;
                doc.setFontSize(14);
                doc.text('Church Directory', margin, yPos);
                yPos += 10;
                const sortedFamilies = [...families].sort((a, b) => (a.familyNo || '').localeCompare(b.familyNo || ''));
                sortedFamilies.forEach((family) => {
                    if (yPos > pageHeight - 40) { doc.addPage(); yPos = 20; }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`#${family.familyNo} - ${family.headOfFamily}`, margin, yPos);
                    yPos += 6;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    if (family.prayerGroup) { doc.text(`Prayer Group: ${family.prayerGroup}`, margin + 5, yPos); yPos += 5; }
                    if (family.mobile) { doc.text(`Mobile: ${family.mobile}`, margin + 5, yPos); yPos += 5; }
                    if (family.email) { doc.text(`Email: ${family.email}`, margin + 5, yPos); yPos += 5; }
                    yPos += 3;
                    doc.line(margin, yPos, 190, yPos);
                    yPos += 5;
                });
                doc.save('church-directory.pdf');
                return true;
            } catch (error) {
                console.error('PDF failed:', error);
                return false;
            }
        }

        function exportToExcel(families) {
            try {
                const sortedFamilies = [...families].sort((a, b) => (a.familyNo || '').localeCompare(b.familyNo || ''));
                const familiesData = sortedFamilies.map(family => ({
                    'Family No': family.familyNo || '',
                    'Head of Family': family.headOfFamily || '',
                    'Prayer Group': family.prayerGroup || '',
                    'Mobile': family.mobile || '',
                    'Email': family.email || '',
                    'Address': family.residentialAddress || '',
                    'Total Members': family.members?.length || 0
                }));
                const membersData = [];
                sortedFamilies.forEach(family => {
                    if (family.members && family.members.length > 0) {
                        family.members.forEach(member => {
                            membersData.push({
                                'Family No': family.familyNo || '',
                                'Family': family.headOfFamily || '',
                                'Name': member.name || '',
                                'Pet Name': member.petName || '',
                                'Identity': member.identity || '',
                                'DOB': member.dob || '',
                                'Mobile': member.mobile || '',
                                'Blood Group': member.bloodGroup || ''
                            });
                        });
                    }
                });
                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.json_to_sheet(familiesData);
                const ws2 = XLSX.utils.json_to_sheet(membersData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Families');
                XLSX.utils.book_append_sheet(wb, ws2, 'Members');
                XLSX.writeFile(wb, 'church-directory.xlsx');
                return true;
            } catch (error) {
                console.error('Excel failed:', error);
                return false;
            }
        }

        function resizeImage(file, maxWidth = 400, maxHeight = 400) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        } else {
                            if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function resizeImageFromDataUrl(dataUrl, maxWidth = 400, maxHeight = 400) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height = Math.round(height * maxWidth / width); width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width = Math.round(width * maxHeight / height); height = maxHeight; }
                    }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = reject;
                img.src = dataUrl;
            });
        }

        // MAIN APP
        function ChurchDirectory() {
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [password, setPassword] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [families, setFamilies] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPrayerGroup, setSelectedPrayerGroup] = useState('All');
            const [selectedFamily, setSelectedFamily] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPin, setAdminPin] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [showManualImport, setShowManualImport] = useState(false);
            const [importJson, setImportJson] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showGitHubSettings, setShowGitHubSettings] = useState(false);
            const [showExportOptions, setShowExportOptions] = useState(false);
            const [showEditFamily, setShowEditFamily] = useState(false);
            const [editingFamily, setEditingFamily] = useState(null);
            const [editingMemberIndex, setEditingMemberIndex] = useState(null);
            const [syncStatus, setSyncStatus] = useState('');
            const [loadingData, setLoadingData] = useState(false);
            const [githubToken, setGithubToken] = useState('');
            const [githubRepo, setGithubRepo] = useState('');
            const [newPin, setNewPin] = useState('');
            const [confirmPin, setConfirmPin] = useState('');
            const [showPhotoIngestion, setShowPhotoIngestion] = useState(false);
            const [ingestedPhotos, setIngestedPhotos] = useState([]);
            const [showPdfIngestion, setShowPdfIngestion] = useState(false);
            const [pdfPageItems, setPdfPageItems] = useState([]);
            const [pdfProcessing, setPdfProcessing] = useState(false);
            const [pdfProgress, setPdfProgress] = useState('');
            const fileInputRef = useRef(null);
            const bulkPhotoInputRef = useRef(null);
            const pdfInputRef = useRef(null);

            useEffect(() => {
                const stored = localStorage.getItem('churchDirectory');
                const storedPassword = localStorage.getItem('directoryPassword');
                if (stored && storedPassword) {
                    try {
                        const data = JSON.parse(stored);
                        setFamilies(data);
                        setPassword(storedPassword);
                        setPasswordInput(storedPassword);
                    } catch (error) { console.error('Failed to load stored data:', error); }
                }
            }, []);

            const handleUnlock = async () => {
                if (!passwordInput) { alert('Please enter your Directory PIN'); return; }
                setLoadingData(true);
                setSyncStatus('ðŸ”“ Unlocking...');
                try {
                    const encryptedData = await directoryCrypto.loadEncryptedFile();
                    setSyncStatus('ðŸ”‘ Decrypting...');
                    const decryptedFamilies = await directoryCrypto.decrypt(encryptedData, passwordInput);
                    setFamilies(decryptedFamilies);
                    setPassword(passwordInput);
                    setIsUnlocked(true);
                    localStorage.setItem('churchDirectory', JSON.stringify(decryptedFamilies));
                    localStorage.setItem('directoryPassword', passwordInput);
                    setSyncStatus('âœ… Loaded ' + decryptedFamilies.length + ' families!');
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) {
                    if (error.message === 'FILE_NOT_FOUND') {
                        const result = confirm('âŒ Could not find data file.\n\nImport manually?');
                        if (result) {
                            setPassword(passwordInput);
                            setIsUnlocked(true);
                            setShowManualImport(true);
                        }
                    } else if (error.message.includes('Incorrect password')) {
                        alert('âŒ Incorrect Directory PIN!');
                    } else {
                        alert('âŒ Failed to load: ' + error.message);
                    }
                    setSyncStatus('');
                }
                setLoadingData(false);
            };

            const handleManualImport = () => {
                try {
                    const data = JSON.parse(importJson);
                    setFamilies(data);
                    localStorage.setItem('churchDirectory', JSON.stringify(data));
                    setSyncStatus('âœ… Imported ' + data.length + ' families!');
                    setShowManualImport(false);
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) { alert('Invalid JSON: ' + error.message); }
            };

            const handleAdminLogin = async () => {
                if (pinManager.verifyPin(adminPin)) {
                    setIsAdmin(true);
                    setShowAdminLogin(false);
                    setAdminPin('');
                    
                    // Decrypt GitHub token with admin PIN
                    try {
                        setSyncStatus('ðŸ” Decrypting GitHub credentials...');
                        const decryptedToken = await directoryCrypto.decrypt(ENCRYPTED_GITHUB_TOKEN, pinManager.getPin());
                        githubSync.setDecryptedToken(decryptedToken);
                        setSyncStatus('âœ… Admin access granted - GitHub sync ready!');
                        setTimeout(() => setSyncStatus(''), 2000);
                    } catch (error) {
                        console.error('Token decryption failed:', error);
                        setSyncStatus('âš ï¸ Admin access granted - GitHub sync unavailable');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } else {
                    alert('âŒ Incorrect PIN');
                }
            };

            const handleChangePIN = () => {
                if (!newPin || !confirmPin) { alert('Please enter both PIN fields'); return; }
                if (newPin.length < 4) { alert('PIN must be at least 4 digits'); return; }
                if (newPin !== confirmPin) { alert('PINs do not match'); return; }
                
                // Warn about GitHub sync
                const confirmed = confirm('âš ï¸ IMPORTANT: Changing your PIN will disable GitHub auto-sync.\n\nThe GitHub token is encrypted with your current PIN. After changing your PIN, you\'ll need to:\n1. Contact your administrator to get a new version, OR\n2. Manually configure GitHub sync with your own token\n\nContinue with PIN change?');
                
                if (!confirmed) return;
                
                pinManager.setPin(newPin);
                githubSync.token = null; // Clear the token since it can't be decrypted with new PIN
                alert('âœ… PIN changed successfully!\n\nâš ï¸ GitHub auto-sync is now disabled. Contact administrator for updated version or configure manually.');
                setNewPin('');
                setConfirmPin('');
                setShowSettings(false);
            };

            const handlePhotoUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { alert('Please select an image file'); return; }
                try {
                    setSyncStatus('ðŸ“¸ Processing photo...');
                    const resizedPhoto = await resizeImage(file);
                    setEditingFamily({...editingFamily, photo: resizedPhoto});
                    setSyncStatus('âœ… Photo added!');
                    setTimeout(() => setSyncStatus(''), 2000);
                } catch (error) {
                    alert('Failed to process photo: ' + error.message);
                    setSyncStatus('');
                }
            };

            const handleBulkPhotoFiles = async (files) => {
                if (!files || files.length === 0) return;
                setSyncStatus('ðŸ“¸ Processing photos...');
                const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
                if (imageFiles.length === 0) { alert('No image files found'); setSyncStatus(''); return; }

                const items = [];
                for (const file of imageFiles) {
                    try {
                        const preview = await resizeImage(file);
                        const nameWithoutExt = file.name.replace(/\.[^.]+$/, '').trim();

                        // Auto-match: try family number first (strip leading zeroes or pad)
                        let matchedFamilyNo = null;
                        const byExactNo = families.find(f => f.familyNo === nameWithoutExt);
                        const byPaddedNo = families.find(f => f.familyNo === nameWithoutExt.padStart(3, '0'));
                        const byStrippedNo = families.find(f => (f.familyNo || '').replace(/^0+/, '') === nameWithoutExt.replace(/^0+/, ''));
                        if (byExactNo) matchedFamilyNo = byExactNo.familyNo;
                        else if (byPaddedNo) matchedFamilyNo = byPaddedNo.familyNo;
                        else if (byStrippedNo) matchedFamilyNo = byStrippedNo.familyNo;
                        else {
                            // Try to match by head of family name (case-insensitive)
                            const lowerName = nameWithoutExt.toLowerCase();
                            const byName = families.find(f =>
                                f.headOfFamily?.toLowerCase().includes(lowerName) ||
                                lowerName.includes((f.headOfFamily || '').toLowerCase())
                            );
                            if (byName) matchedFamilyNo = byName.familyNo;
                        }

                        items.push({ filename: file.name, preview, matchedFamilyNo });
                    } catch (err) {
                        console.error('Failed to process', file.name, err);
                    }
                }
                setIngestedPhotos(items);
                setSyncStatus('');
            };

            const handleApplyIngestedPhotos = async () => {
                const matched = ingestedPhotos.filter(p => p.matchedFamilyNo);
                if (matched.length === 0) { alert('No photos have a matched family'); return; }

                setSyncStatus(`ðŸ“¸ Applying ${matched.length} photo(s)...`);
                const updated = [...families];
                let appliedCount = 0;
                for (const item of matched) {
                    const idx = updated.findIndex(f => f.familyNo === item.matchedFamilyNo);
                    if (idx >= 0) { updated[idx] = { ...updated[idx], photo: item.preview }; appliedCount++; }
                }

                setFamilies(updated);
                localStorage.setItem('churchDirectory', JSON.stringify(updated));

                if (githubSync.isConfigured() && password) {
                    try {
                        setSyncStatus('â˜ï¸ Syncing to GitHub...');
                        const encrypted = await directoryCrypto.encrypt(updated, password);
                        await githubSync.uploadData(encrypted, `Bulk photo update - ${appliedCount} photos added`);
                        setSyncStatus(`âœ… Applied ${appliedCount} photo(s) and synced!`);
                    } catch (error) {
                        setSyncStatus(`âœ… Applied ${appliedCount} photo(s) (GitHub sync failed)`);
                        console.error('GitHub sync error:', error);
                    }
                } else {
                    setSyncStatus(`âœ… Applied ${appliedCount} photo(s) locally!`);
                }

                setTimeout(() => setSyncStatus(''), 3000);
                setShowPhotoIngestion(false);
                setIngestedPhotos([]);
            };

            const parseFamilyDataFromText = (text) => {
                if (!text) return {};
                const d = {};
                // Family number: #001, No. 1, Family No: 1, etc.
                for (const pat of [/#\s*(\d+)/, /Family\s+No\.?\s*[:\-]?\s*(\d+)/i, /\bNo\.?\s*[:\-]?\s*(\d+)/i]) {
                    const m = text.match(pat);
                    if (m) { d.familyNo = m[1].padStart(3, '0'); break; }
                }
                // Head of family
                const hofM = text.match(/(?:Head\s+of\s+Family|HOF)\s*[:\-]?\s*([A-Za-z][^\n\r,;:]{2,50})/i);
                if (hofM) d.headOfFamily = hofM[1].trim();
                // Prayer group
                const pgM = text.match(/(?:Prayer\s+Group|PG)\s*[:\-]?\s*([A-Za-z\d][^\n\r,;:]{1,30})/i);
                if (pgM) d.prayerGroup = pgM[1].trim();
                // Mobile/phone
                const mobM = text.match(/(?:Mobile|Phone|Tel|Cell|Mob)\s*[:\-]?\s*([+\d][\d\s()+-]{5,20})/i);
                if (mobM) d.mobile = mobM[1].trim();
                // Email
                const emailM = text.match(/\b[A-Za-z0-9._%+\-]+@[A-Za-z0-9.\-]+\.[A-Za-z]{2,}\b/);
                if (emailM) d.email = emailM[0];
                // Address
                const addrM = text.match(/(?:Address|Residence|Residential)\s*[:\-]?\s*([^\n\r]{5,100})/i);
                if (addrM) d.residentialAddress = addrM[1].trim();
                return d;
            };

            const processPdfFile = async (file) => {
                if (!file || file.type !== 'application/pdf') { alert('Please select a PDF file'); return; }
                if (!window.pdfjsLib) { alert('PDF.js library not loaded. Please refresh and try again.'); return; }
                setPdfProcessing(true);
                setPdfProgress('Loading PDF...');
                setPdfPageItems([]);
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const totalPages = pdf.numPages;
                    const items = [];

                    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                        setPdfProgress(`Processing page ${pageNum} of ${totalPages}...`);
                        const page = await pdf.getPage(pageNum);

                        // Render full page as fallback photo source
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                        const pageRender = canvas.toDataURL('image/jpeg', 0.85);

                        // Extract text â€” sort items topâ†’bottom, leftâ†’right for reliable reading order
                        let extractedText = '';
                        try {
                            const tc = await page.getTextContent();
                            const sorted = tc.items.slice().sort((a, b) => {
                                const yDiff = (b.transform[5] || 0) - (a.transform[5] || 0);
                                return Math.abs(yDiff) > 2 ? yDiff : ((a.transform[4] || 0) - (b.transform[4] || 0));
                            });
                            extractedText = sorted.map(i => i.str).join(' ').trim();
                        } catch(e) {}

                        // Parse structured family info from text
                        const parsedData = parseFamilyDataFromText(extractedText);

                        // Extract embedded images â€” check both paintImageXObject AND paintJpegXObject
                        const embeddedImages = [];
                        try {
                            const ops = await page.getOperatorList();
                            const imgRefs = new Set();
                            const OPS = pdfjsLib.OPS;
                            for (let i = 0; i < ops.fnArray.length; i++) {
                                const fn = ops.fnArray[i];
                                const isImg = fn === OPS.paintImageXObject || fn === OPS.paintJpegXObject;
                                if (isImg && ops.argsArray[i] && ops.argsArray[i][0]) {
                                    imgRefs.add(ops.argsArray[i][0]);
                                }
                            }
                            for (const ref of imgRefs) {
                                try {
                                    // Try page-level objects, fall back to common (shared) objects
                                    const getObj = (store, key) => new Promise(res => {
                                        try { store.get(key, res); } catch(e) { res(null); }
                                    });
                                    let imgObj = await Promise.race([getObj(page.objs, ref), new Promise(res => setTimeout(() => res(null), 800))]);
                                    if (!imgObj) imgObj = await Promise.race([getObj(page.commonObjs, ref), new Promise(res => setTimeout(() => res(null), 800))]);
                                    if (!imgObj || !imgObj.width || !imgObj.height) continue;
                                    if (imgObj.width < 60 || imgObj.height < 60) continue;

                                    let dataUrl = null;
                                    if (imgObj.bitmap) {
                                        // ImageBitmap (newer PDF.js)
                                        const bc = document.createElement('canvas');
                                        bc.width = imgObj.bitmap.width; bc.height = imgObj.bitmap.height;
                                        bc.getContext('2d').drawImage(imgObj.bitmap, 0, 0);
                                        dataUrl = bc.toDataURL('image/jpeg', 0.85);
                                    } else if (imgObj.data) {
                                        const ic = document.createElement('canvas');
                                        ic.width = imgObj.width; ic.height = imgObj.height;
                                        let rgba;
                                        if (imgObj.kind === 2) { // RGB_24BPP â†’ RGBA
                                            rgba = new Uint8ClampedArray(imgObj.width * imgObj.height * 4);
                                            for (let p = 0; p < imgObj.width * imgObj.height; p++) {
                                                rgba[p*4]=imgObj.data[p*3]; rgba[p*4+1]=imgObj.data[p*3+1];
                                                rgba[p*4+2]=imgObj.data[p*3+2]; rgba[p*4+3]=255;
                                            }
                                        } else if (imgObj.kind === 3) { // RGBA_32BPP
                                            rgba = new Uint8ClampedArray(imgObj.data.buffer || imgObj.data);
                                        } else if (imgObj.kind === 1) { // GRAYSCALE â†’ RGBA
                                            rgba = new Uint8ClampedArray(imgObj.width * imgObj.height * 4);
                                            for (let p = 0; p < imgObj.width * imgObj.height; p++) {
                                                const v = imgObj.data[p]; rgba[p*4]=v; rgba[p*4+1]=v; rgba[p*4+2]=v; rgba[p*4+3]=255;
                                            }
                                        }
                                        if (rgba) {
                                            try {
                                                ic.getContext('2d').putImageData(new ImageData(rgba, imgObj.width, imgObj.height), 0, 0);
                                                dataUrl = ic.toDataURL('image/jpeg', 0.85);
                                            } catch(convErr) {}
                                        }
                                    }
                                    if (dataUrl) embeddedImages.push(dataUrl);
                                } catch(imgErr) { /* skip */ }
                            }
                        } catch(opsErr) { /* embedded extraction unsupported, page render is the fallback */ }

                        // Auto-match: prefer parsedData.familyNo, then text patterns, then name
                        let matchedFamilyNo = null;
                        if (parsedData.familyNo) {
                            const f = families.find(f => f.familyNo === parsedData.familyNo);
                            if (f) matchedFamilyNo = f.familyNo;
                        }
                        if (!matchedFamilyNo && extractedText) {
                            const lowerText = extractedText.toLowerCase();
                            for (const pat of [/#(\d+)/, /\bNo\.?\s*(\d+)/i, /\b(\d{1,3})\b/]) {
                                const m = extractedText.match(pat);
                                if (m) {
                                    const padded = m[1].padStart(3, '0');
                                    const f = families.find(f => f.familyNo === padded || f.familyNo === m[1]);
                                    if (f) { matchedFamilyNo = f.familyNo; break; }
                                }
                            }
                            if (!matchedFamilyNo) {
                                // Match by full name or first word of name (last name usually distinct)
                                const byName = families.find(f => f.headOfFamily && lowerText.includes(f.headOfFamily.toLowerCase()));
                                if (byName) matchedFamilyNo = byName.familyNo;
                            }
                            if (!matchedFamilyNo && parsedData.headOfFamily) {
                                const firstName = parsedData.headOfFamily.split(' ')[0].toLowerCase();
                                if (firstName.length > 3) {
                                    const byFirst = families.find(f => f.headOfFamily && f.headOfFamily.toLowerCase().startsWith(firstName));
                                    if (byFirst) matchedFamilyNo = byFirst.familyNo;
                                }
                            }
                        }

                        items.push({
                            pageNum, pageRender, embeddedImages,
                            textSnippet: extractedText.substring(0, 150),
                            parsedData,
                            matchedFamilyNo,
                            useEmbedded: embeddedImages.length > 0
                        });
                    }
                    setPdfPageItems(items);
                    setPdfProgress('');
                } catch(error) {
                    alert('Failed to process PDF: ' + error.message);
                    console.error('PDF processing error:', error);
                    setPdfProgress('');
                }
                setPdfProcessing(false);
            };

            const handleApplyPdfPhotos = async () => {
                const matched = pdfPageItems.filter(p => p.matchedFamilyNo);
                if (matched.length === 0) {
                    alert('No families assigned yet.\n\nUse the dropdown next to each page to pick the matching family, then click Apply.');
                    return;
                }
                setSyncStatus(`ðŸ“¥ Importing ${matched.length} page(s) from PDF...`);
                const updated = [...families];
                let photoCount = 0, infoCount = 0;
                for (const item of matched) {
                    const idx = updated.findIndex(f => f.familyNo === item.matchedFamilyNo);
                    if (idx < 0) continue;
                    let changed = Object.assign({}, updated[idx]);

                    // Apply photo (embedded preferred, else full-page render)
                    try {
                        const src = (item.useEmbedded && item.embeddedImages.length > 0) ? item.embeddedImages[0] : item.pageRender;
                        changed.photo = await resizeImageFromDataUrl(src);
                        photoCount++;
                    } catch(e) { console.error('Photo resize failed for', item.matchedFamilyNo, e); }

                    // Apply parsed info fields (only overwrite if the PDF had a value)
                    const d = item.parsedData || {};
                    if (d.prayerGroup) { changed.prayerGroup = d.prayerGroup; infoCount++; }
                    if (d.mobile) { changed.mobile = d.mobile; infoCount++; }
                    if (d.email) { changed.email = d.email; infoCount++; }
                    if (d.residentialAddress) { changed.residentialAddress = d.residentialAddress; infoCount++; }
                    // Only fill name if the family record has none (never overwrite existing name)
                    if (d.headOfFamily && !changed.headOfFamily) { changed.headOfFamily = d.headOfFamily; infoCount++; }

                    updated[idx] = changed;
                }
                setFamilies(updated);
                localStorage.setItem('churchDirectory', JSON.stringify(updated));
                const summary = `${photoCount} photo(s)${infoCount > 0 ? ', ' + infoCount + ' info field(s)' : ''}`;
                if (githubSync.isConfigured() && password) {
                    try {
                        setSyncStatus('â˜ï¸ Syncing to GitHub...');
                        const encrypted = await directoryCrypto.encrypt(updated, password);
                        await githubSync.uploadData(encrypted, `PDF import â€” ${summary} updated`);
                        setSyncStatus(`âœ… Imported ${summary} â€” synced!`);
                    } catch(error) {
                        setSyncStatus(`âœ… Imported ${summary} â€” saved locally`);
                    }
                } else {
                    setSyncStatus(`âœ… Imported ${summary}!`);
                }
                setTimeout(() => setSyncStatus(''), 4000);
                setShowPdfIngestion(false);
                setPdfPageItems([]);
            };

            const handleEditFamily = (family) => {
                if (!family.members) family.members = [];
                setEditingFamily(family);
                setShowEditFamily(true);
            };

            const handleAddMember = () => {
                const newMember = { name: '', petName: '', identity: '', dob: '', mobile: '', bloodGroup: '', inKwt: '', memNo: '' };
                const updatedMembers = [...(editingFamily.members || []), newMember];
                setEditingFamily({...editingFamily, members: updatedMembers});
                setEditingMemberIndex(updatedMembers.length - 1);
            };

            const handleUpdateMember = (index, field, value) => {
                const updatedMembers = [...editingFamily.members];
                updatedMembers[index] = {...updatedMembers[index], [field]: value};
                setEditingFamily({...editingFamily, members: updatedMembers});
            };

            const handleDeleteMember = (index) => {
                if (confirm('Delete this family member?')) {
                    const updatedMembers = editingFamily.members.filter((_, i) => i !== index);
                    setEditingFamily({...editingFamily, members: updatedMembers});
                    if (editingMemberIndex === index) setEditingMemberIndex(null);
                }
            };

            const handleSaveFamily = async () => {
                if (!editingFamily.headOfFamily) { alert('Please enter head of family name'); return; }
                const updated = [...families];
                const index = updated.findIndex(f => f.familyNo === editingFamily.familyNo);
                if (index >= 0) { updated[index] = editingFamily; } else { updated.push(editingFamily); }
                
                setSyncStatus('ðŸ’¾ Saving...');
                setFamilies(updated);
                localStorage.setItem('churchDirectory', JSON.stringify(updated));
                
                // GitHub Auto-Sync
                if (githubSync.isConfigured() && password) {
                    try {
                        setSyncStatus('â˜ï¸ Syncing to GitHub...');
                        const encrypted = await directoryCrypto.encrypt(updated, password);
                        await githubSync.uploadData(encrypted);
                        setSyncStatus('âœ… Saved and published!');
                    } catch (error) {
                        setSyncStatus('âš ï¸ Saved locally (GitHub sync failed)');
                        console.error('GitHub sync error:', error);
                    }
                } else {
                    setSyncStatus('âœ… Saved locally!');
                }
                
                setTimeout(() => setSyncStatus(''), 2000);
                setShowEditFamily(false);
                setEditingFamily(null);
                setEditingMemberIndex(null);
            };

            const exportEncrypted = async () => {
                try {
                    if (!password) { alert('âŒ Password not available'); return; }
                    setSyncStatus('ðŸ“¦ Encrypting...');
                    const encrypted = await directoryCrypto.encrypt(families, password);
                    setSyncStatus('ðŸ’¾ Downloading...');
                    if (downloadFile(encrypted, 'families.json.enc', 'text/plain')) {
                        setSyncStatus('âœ… Downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) { alert('âŒ Export failed: ' + error.message); }
            };

            const exportPlainJSON = () => {
                try {
                    setSyncStatus('ðŸ“¦ Preparing...');
                    const jsonString = JSON.stringify(families, null, 2);
                    if (downloadFile(jsonString, 'families-backup.json', 'application/json')) {
                        setSyncStatus('âœ… Downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) { alert('âŒ Export failed: ' + error.message); }
            };

            const exportPDF = () => {
                try {
                    setSyncStatus('ðŸ“„ Generating PDF...');
                    if (exportToPDF(families)) {
                        setSyncStatus('âœ… PDF downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) { alert('âŒ PDF failed: ' + error.message); }
            };

            const exportExcel = () => {
                try {
                    setSyncStatus('ðŸ“Š Generating Excel...');
                    if (exportToExcel(families)) {
                        setSyncStatus('âœ… Excel downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) { alert('âŒ Excel failed: ' + error.message); }
            };

            const saveGitHubConfig = async () => {
                try {
                    githubSync.saveConfig(githubToken, githubRepo);
                    const result = await githubSync.testConnection();
                    alert('âœ… Connected successfully to ' + result.full_name);
                    setShowGitHubSettings(false);
                } catch (error) {
                    alert('âŒ Connection failed: ' + error.message);
                }
            };

            const filteredFamilies = useMemo(() => {
                return families.filter(family => {
                    const matchesSearch = searchTerm === '' || 
                        family.headOfFamily?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        family.familyNo?.includes(searchTerm);
                    const matchesPrayerGroup = selectedPrayerGroup === 'All' || family.prayerGroup === selectedPrayerGroup;
                    return matchesSearch && matchesPrayerGroup;
                });
            }, [families, searchTerm, selectedPrayerGroup]);

            const prayerGroups = useMemo(() => {
                const groups = new Set(families.map(f => f.prayerGroup).filter(Boolean));
                return ['All', ...Array.from(groups).sort()];
            }, [families]);

            if (!isUnlocked) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-4">
                        <div className="glass-effect rounded-3xl p-12 max-w-md w-full shadow-2xl">
                            <h1 className="text-4xl font-black text-white text-center mb-2">St Thomas MTC</h1>
                            <p className="text-white/80 text-center mb-4">Salmiya, Kuwait</p>
                            <div className="bg-green-500/20 border border-green-500/50 rounded-xl p-3 mb-6 text-center">
                                <div className="text-white font-bold text-sm">ðŸ” Dual-PIN Security</div>
                                <div className="text-white/80 text-xs mt-1">Directory PIN: View access â€¢ Admin PIN: Edit access</div>
                            </div>
                            {loadingData ? (
                                <div className="text-center">
                                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-white mx-auto mb-4"></div>
                                    <p className="text-white">{syncStatus}</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <input
                                        type="password"
                                        placeholder="Enter Directory PIN"
                                        value={passwordInput}
                                        onChange={(e) => setPasswordInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleUnlock()}
                                        className="w-full px-6 py-4 rounded-xl bg-white/10 border-2 border-white/30 text-white placeholder-white/50 focus:outline-none focus:border-white/60 text-center text-2xl tracking-widest"
                                        maxLength="6"
                                        inputMode="numeric"
                                        pattern="[0-9]*"
                                    />
                                    <button
                                        onClick={handleUnlock}
                                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 rounded-xl shadow-lg"
                                    >
                                        ðŸ”“ Unlock with PIN
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (showManualImport) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl p-8 max-w-4xl w-full">
                            <h2 className="text-2xl font-bold mb-4">Manual Data Import</h2>
                            <textarea
                                value={importJson}
                                onChange={(e) => setImportJson(e.target.value)}
                                placeholder='[{"familyNo":"001",...}]'
                                className="w-full h-96 p-4 border-2 border-gray-300 rounded-xl font-mono text-sm mb-4"
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={handleManualImport}
                                    className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold"
                                >
                                    Import
                                </button>
                                <button
                                    onClick={() => setShowManualImport(false)}
                                    className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-3xl p-6 mb-6 shadow-2xl">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-black text-white">St Thomas MTC</h1>
                                    <p className="text-white/90 mt-1">{families.length} Families â€¢ {githubSync.isConfigured() ? 'ðŸ” PIN-Encrypted Sync' : 'ðŸ’¾ Local Only'}</p>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {!isAdmin ? (
                                        <button
                                            onClick={() => setShowAdminLogin(true)}
                                            className="bg-white text-purple-700 px-6 py-3 rounded-xl font-bold hover:bg-white/90"
                                        >
                                            ðŸ” Admin
                                        </button>
                                    ) : (
                                        <>
                                            <button
                                                onClick={() => setShowSettings(true)}
                                                className="bg-white/20 text-white px-4 py-3 rounded-xl font-bold hover:bg-white/30"
                                                title="Settings"
                                            >
                                                âš™ï¸
                                            </button>
                                            <button
                                                onClick={() => setShowGitHubSettings(true)}
                                                className="bg-white/20 text-white px-4 py-3 rounded-xl font-bold hover:bg-white/30"
                                                title="GitHub"
                                            >
                                                ðŸ”„
                                            </button>
                                            <button
                                                onClick={() => setShowPhotoIngestion(true)}
                                                className="bg-pink-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-pink-700"
                                                title="Bulk Photo Ingestion"
                                            >
                                                ðŸ“¸
                                            </button>
                                            <button
                                                onClick={() => setShowPdfIngestion(true)}
                                                className="bg-orange-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-orange-700"
                                                title="Import Photos from PDF"
                                            >
                                                ðŸ“„
                                            </button>
                                            <button
                                                onClick={() => setShowManualImport(true)}
                                                className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700"
                                                title="Import"
                                            >
                                                ðŸ“¥
                                            </button>
                                            <button
                                                onClick={() => setShowExportOptions(true)}
                                                className="bg-yellow-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-yellow-700"
                                                title="Export"
                                            >
                                                ðŸ“¤
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                            {syncStatus && (
                                <div className="mt-4 bg-white/20 rounded-xl p-3 text-white font-bold text-center">
                                    {syncStatus}
                                </div>
                            )}
                        </div>

                        <div className="glass-effect rounded-3xl p-6 mb-6 shadow-xl">
                            <div className="grid md:grid-cols-2 gap-4">
                                <input
                                    type="text"
                                    placeholder="ðŸ” Search..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="px-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 focus:outline-none"
                                />
                                <select
                                    value={selectedPrayerGroup}
                                    onChange={(e) => setSelectedPrayerGroup(e.target.value)}
                                    className="px-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 focus:outline-none"
                                >
                                    {prayerGroups.map(group => (
                                        <option key={group} value={group}>{group}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredFamilies.map(family => (
                                <div
                                    key={family.familyNo}
                                    onClick={() => setSelectedFamily(family)}
                                    className="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all cursor-pointer transform hover:scale-105"
                                >
                                    <div className="flex gap-4 mb-3">
                                        {family.photo ? (
                                            <img
                                                src={family.photo}
                                                alt={family.headOfFamily}
                                                className="w-16 h-16 rounded-full object-cover border-2 border-white"
                                            />
                                        ) : (
                                            <div className="w-16 h-16 rounded-full bg-purple-500/50 flex items-center justify-center text-white text-2xl font-bold">
                                                {family.headOfFamily?.charAt(0) || '?'}
                                            </div>
                                        )}
                                        <div className="flex-1">
                                            <div className="text-purple-200 text-sm font-bold">#{family.familyNo}</div>
                                            <h3 className="text-white text-xl font-bold mt-1">{family.headOfFamily}</h3>
                                            <div className="bg-purple-500/50 inline-block px-3 py-1 rounded-lg text-white text-xs font-bold mt-1">
                                                {family.prayerGroup}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-2 text-white/80 text-sm">
                                        {family.mobile && <div>ðŸ“± {family.mobile}</div>}
                                        {family.email && <div className="truncate">âœ‰ï¸ {family.email}</div>}
                                        <div>ðŸ‘¥ {family.members?.length || 0} members</div>
                                    </div>
                                    {isAdmin && (
                                        <button
                                            onClick={(e) => { e.stopPropagation(); handleEditFamily(family); }}
                                            onTouchEnd={(e) => { e.stopPropagation(); e.preventDefault(); handleEditFamily(family); }}
                                            className="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-xl text-sm font-bold"
                                        >
                                            âœï¸ Edit
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>

                        {filteredFamilies.length === 0 && (
                            <div className="glass-effect rounded-3xl p-12 text-center">
                                <p className="text-white/80 text-xl">
                                    {families.length === 0 ? 'No families loaded' : 'No families found'}
                                </p>
                            </div>
                        )}

                        {/* Photo Ingestion Modal */}
                        {showPhotoIngestion && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-4xl w-full my-8"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold">ðŸ“¸ Bulk Photo Ingestion</h2>
                                        <button
                                            onClick={() => { setShowPhotoIngestion(false); setIngestedPhotos([]); }}
                                            className="text-gray-500 hover:text-gray-700 text-3xl leading-none"
                                        >Ã—</button>
                                    </div>

                                    <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm text-blue-800">
                                        <strong>Auto-matching:</strong> Files are matched to families by filename. Name files by family number (e.g. <code className="bg-blue-100 px-1 rounded">001.jpg</code>) or by the head of family name (e.g. <code className="bg-blue-100 px-1 rounded">Smith.jpg</code>). You can manually reassign any match below.
                                    </div>

                                    {/* Drop zone */}
                                    <div
                                        className="border-4 border-dashed border-gray-300 rounded-2xl p-12 text-center mb-6 hover:border-purple-400 hover:bg-purple-50 transition-colors cursor-pointer"
                                        onClick={() => bulkPhotoInputRef.current?.click()}
                                        onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-purple-400', 'bg-purple-50'); }}
                                        onDragLeave={(e) => { e.currentTarget.classList.remove('border-purple-400', 'bg-purple-50'); }}
                                        onDrop={async (e) => {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('border-purple-400', 'bg-purple-50');
                                            await handleBulkPhotoFiles(e.dataTransfer.files);
                                        }}
                                    >
                                        <div className="text-5xl mb-3">ðŸ“‚</div>
                                        <div className="text-gray-600 font-bold text-lg">Drop photos here or click to select</div>
                                        <div className="text-gray-400 text-sm mt-1">Multiple image files supported â€” JPG, PNG, WEBP, etc.</div>
                                        <input
                                            ref={bulkPhotoInputRef}
                                            type="file"
                                            accept="image/*"
                                            multiple
                                            className="hidden"
                                            onChange={(e) => handleBulkPhotoFiles(e.target.files)}
                                        />
                                    </div>

                                    {/* Review table */}
                                    {ingestedPhotos.length > 0 && (
                                        <div>
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="font-bold text-lg">{ingestedPhotos.length} photo(s) loaded â€” review &amp; confirm matches</h3>
                                                <span className="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                                    {ingestedPhotos.filter(p => p.matchedFamilyNo).length} / {ingestedPhotos.length} matched
                                                </span>
                                            </div>

                                            <div className="space-y-2 max-h-96 overflow-y-auto border-2 border-gray-100 rounded-xl p-3">
                                                {ingestedPhotos.map((item, idx) => (
                                                    <div key={idx} className="flex items-center gap-4 bg-gray-50 rounded-xl p-3 border border-gray-200">
                                                        <img
                                                            src={item.preview}
                                                            alt={item.filename}
                                                            className="w-14 h-14 rounded-full object-cover border-2 border-gray-300 flex-shrink-0"
                                                        />
                                                        <div className="flex-1 min-w-0">
                                                            <div className="text-sm font-bold text-gray-800 truncate">{item.filename}</div>
                                                            {item.matchedFamilyNo
                                                                ? <div className="text-xs text-green-600 font-semibold mt-0.5">âœ… Auto-matched</div>
                                                                : <div className="text-xs text-orange-500 font-semibold mt-0.5">âš ï¸ No auto-match â€” assign manually</div>
                                                            }
                                                        </div>
                                                        <div className="flex-shrink-0 w-52">
                                                            <select
                                                                value={item.matchedFamilyNo || ''}
                                                                onChange={(e) => {
                                                                    const updated = [...ingestedPhotos];
                                                                    updated[idx] = { ...updated[idx], matchedFamilyNo: e.target.value || null };
                                                                    setIngestedPhotos(updated);
                                                                }}
                                                                className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm"
                                                            >
                                                                <option value="">-- Unassigned --</option>
                                                                {[...families].sort((a, b) => (a.familyNo || '').localeCompare(b.familyNo || '')).map(f => (
                                                                    <option key={f.familyNo} value={f.familyNo}>#{f.familyNo} {f.headOfFamily}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                const updated = ingestedPhotos.filter((_, i) => i !== idx);
                                                                setIngestedPhotos(updated);
                                                            }}
                                                            className="flex-shrink-0 text-red-400 hover:text-red-600 text-xl leading-none"
                                                            title="Remove"
                                                        >Ã—</button>
                                                    </div>
                                                ))}
                                            </div>

                                            <div className="flex gap-3 mt-6">
                                                <button
                                                    onClick={handleApplyIngestedPhotos}
                                                    disabled={!ingestedPhotos.some(p => p.matchedFamilyNo)}
                                                    className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white py-3 rounded-xl font-bold"
                                                >
                                                    âœ… Apply {ingestedPhotos.filter(p => p.matchedFamilyNo).length} Photo(s)
                                                </button>
                                                <button
                                                    onClick={() => setIngestedPhotos([])}
                                                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold"
                                                >
                                                    Clear
                                                </button>
                                                <button
                                                    onClick={() => { setShowPhotoIngestion(false); setIngestedPhotos([]); }}
                                                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {ingestedPhotos.length === 0 && (
                                        <div className="flex justify-end">
                                            <button
                                                onClick={() => { setShowPhotoIngestion(false); setIngestedPhotos([]); }}
                                                className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold"
                                            >
                                                Close
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* PDF Photo Import Modal */}
                        {showPdfIngestion && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-4xl w-full my-8"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold">ðŸ“„ Import Photos from PDF</h2>
                                        <button
                                            onClick={() => { setShowPdfIngestion(false); setPdfPageItems([]); }}
                                            className="text-gray-500 hover:text-gray-700 text-3xl leading-none"
                                        >Ã—</button>
                                    </div>

                                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 text-sm text-amber-800">
                                        <strong>How it works:</strong> Upload your family directory PDF. Each page is rendered and text is scanned to auto-match families by name or number. Embedded photos are extracted where possible â€” look for the <span className="bg-green-100 text-green-700 font-bold px-1 rounded">âœ“</span> badge. Review all matches before applying.
                                    </div>

                                    {/* Upload / drop zone (shown when no pages loaded) */}
                                    {!pdfProcessing && pdfPageItems.length === 0 && (
                                        <div
                                            className="border-4 border-dashed border-gray-300 rounded-2xl p-12 text-center mb-6 hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer"
                                            onClick={() => pdfInputRef.current?.click()}
                                            onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-orange-400','bg-orange-50'); }}
                                            onDragLeave={(e) => { e.currentTarget.classList.remove('border-orange-400','bg-orange-50'); }}
                                            onDrop={async (e) => {
                                                e.preventDefault();
                                                e.currentTarget.classList.remove('border-orange-400','bg-orange-50');
                                                if (e.dataTransfer.files[0]) await processPdfFile(e.dataTransfer.files[0]);
                                            }}
                                        >
                                            <div className="text-5xl mb-3">ðŸ“„</div>
                                            <div className="text-gray-600 font-bold text-lg">Drop PDF here or click to select</div>
                                            <div className="text-gray-400 text-sm mt-1">Family directory PDF with embedded photos</div>
                                            <input
                                                ref={pdfInputRef}
                                                type="file"
                                                accept="application/pdf"
                                                className="hidden"
                                                onChange={async (e) => { if (e.target.files[0]) await processPdfFile(e.target.files[0]); }}
                                            />
                                        </div>
                                    )}

                                    {/* Processing spinner */}
                                    {pdfProcessing && (
                                        <div className="text-center py-12">
                                            <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-500 mx-auto mb-4"></div>
                                            <p className="text-gray-700 font-bold">{pdfProgress || 'Processing PDF...'}</p>
                                            <p className="text-gray-400 text-sm mt-1">Rendering pages and extracting images â€” please wait</p>
                                        </div>
                                    )}

                                    {/* Review table */}
                                    {!pdfProcessing && pdfPageItems.length > 0 && (
                                        <div>
                                            <div className="flex justify-between items-center mb-3">
                                                <div className="flex items-center gap-3">
                                                    <h3 className="font-bold text-lg">{pdfPageItems.length} page(s) processed</h3>
                                                    <button
                                                        onClick={() => { setPdfPageItems([]); if (pdfInputRef.current) pdfInputRef.current.value = ''; }}
                                                        className="text-sm text-blue-600 hover:text-blue-800 underline"
                                                    >Upload different PDF</button>
                                                </div>
                                                <span className="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                                    {pdfPageItems.filter(p => p.matchedFamilyNo).length} / {pdfPageItems.length} matched
                                                </span>
                                            </div>

                                            {/* Callout when nothing auto-matched */}
                                            {pdfPageItems.every(p => !p.matchedFamilyNo) && (
                                                <div className="bg-orange-50 border border-orange-300 rounded-xl p-3 mb-3 text-sm text-orange-800">
                                                    <strong>No auto-matches found.</strong> The PDF text didn't contain recognisable family numbers or names. Use the <strong>dropdown on each row</strong> to assign a family manually, then click Apply.
                                                </div>
                                            )}

                                            <div className="space-y-2 max-h-96 overflow-y-auto border-2 border-gray-100 rounded-xl p-3">
                                                {pdfPageItems.map((item, idx) => {
                                                    const photoSrc = (item.useEmbedded && item.embeddedImages.length > 0)
                                                        ? item.embeddedImages[0] : item.pageRender;
                                                    const pd = item.parsedData || {};
                                                    const parsedFields = [
                                                        pd.headOfFamily && ('Name: ' + pd.headOfFamily),
                                                        pd.prayerGroup && ('PG: ' + pd.prayerGroup),
                                                        pd.mobile && ('ðŸ“± ' + pd.mobile),
                                                        pd.email && ('âœ‰ ' + pd.email),
                                                    ].filter(Boolean);
                                                    return (
                                                        <div key={idx} className="bg-gray-50 rounded-xl p-3 border border-gray-200">
                                                            <div className="flex items-start gap-3">
                                                                {/* Thumbnail */}
                                                                <div className="flex-shrink-0 relative">
                                                                    <img
                                                                        src={photoSrc}
                                                                        alt={'Page ' + item.pageNum}
                                                                        className="w-14 h-14 rounded-lg object-cover border-2 border-gray-300"
                                                                        title={item.embeddedImages.length > 0 ? item.embeddedImages.length + ' embedded image(s) found' : 'Page render'}
                                                                    />
                                                                    {item.embeddedImages.length > 0 && (
                                                                        <span className="absolute -top-1 -right-1 bg-green-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center font-bold" title="Embedded photo extracted">âœ“</span>
                                                                    )}
                                                                </div>

                                                                {/* Info column */}
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="flex items-center gap-2 flex-wrap">
                                                                        <span className="text-sm font-bold text-gray-700">Page {item.pageNum}</span>
                                                                        {item.embeddedImages.length > 0 && (
                                                                            <button
                                                                                onClick={() => {
                                                                                    const u = [...pdfPageItems];
                                                                                    u[idx] = Object.assign({}, u[idx], { useEmbedded: !u[idx].useEmbedded });
                                                                                    setPdfPageItems(u);
                                                                                }}
                                                                                className={'text-xs px-2 py-0.5 rounded font-semibold border ' + (item.useEmbedded ? 'bg-green-50 border-green-300 text-green-700' : 'bg-gray-100 border-gray-300 text-gray-600')}
                                                                            >
                                                                                {item.useEmbedded ? 'ðŸ“· Embedded photo' : 'ðŸ–¼ Page render'}
                                                                            </button>
                                                                        )}
                                                                        {item.matchedFamilyNo
                                                                            ? <span className="text-xs text-green-600 font-semibold">âœ… Auto-matched</span>
                                                                            : <span className="text-xs text-orange-500 font-semibold">âš ï¸ Assign family â†’</span>
                                                                        }
                                                                    </div>
                                                                    {/* Parsed info chips */}
                                                                    {parsedFields.length > 0 && (
                                                                        <div className="flex flex-wrap gap-1 mt-1.5">
                                                                            {parsedFields.map((f, fi) => (
                                                                                <span key={fi} className="text-xs bg-blue-50 border border-blue-200 text-blue-700 px-1.5 py-0.5 rounded">{f}</span>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                    {parsedFields.length === 0 && item.textSnippet && (
                                                                        <div className="text-xs text-gray-400 truncate mt-0.5" title={item.textSnippet}>{item.textSnippet}</div>
                                                                    )}
                                                                </div>

                                                                {/* Family dropdown + remove */}
                                                                <div className="flex items-center gap-2 flex-shrink-0">
                                                                    <select
                                                                        value={item.matchedFamilyNo || ''}
                                                                        onChange={(e) => {
                                                                            const u = [...pdfPageItems];
                                                                            u[idx] = Object.assign({}, u[idx], { matchedFamilyNo: e.target.value || null });
                                                                            setPdfPageItems(u);
                                                                        }}
                                                                        className={'w-48 px-2 py-1.5 border rounded-lg text-sm ' + (item.matchedFamilyNo ? 'border-green-400 bg-green-50' : 'border-orange-300 bg-orange-50')}
                                                                    >
                                                                        <option value="">-- Assign family --</option>
                                                                        {[...families].sort((a, b) => (a.familyNo || '').localeCompare(b.familyNo || '')).map(f => (
                                                                            <option key={f.familyNo} value={f.familyNo}>#{f.familyNo} {f.headOfFamily}</option>
                                                                        ))}
                                                                    </select>
                                                                    <button
                                                                        onClick={() => setPdfPageItems(pdfPageItems.filter((_, i) => i !== idx))}
                                                                        className="text-red-400 hover:text-red-600 text-xl leading-none"
                                                                        title="Remove"
                                                                    >Ã—</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>

                                            <div className="flex gap-3 mt-6">
                                                <button
                                                    onClick={handleApplyPdfPhotos}
                                                    disabled={!pdfPageItems.some(p => p.matchedFamilyNo)}
                                                    className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white py-3 rounded-xl font-bold"
                                                >
                                                    âœ… Import {pdfPageItems.filter(p => p.matchedFamilyNo).length} Family Record(s)
                                                </button>
                                                <button
                                                    onClick={() => { setPdfPageItems([]); if (pdfInputRef.current) pdfInputRef.current.value = ''; }}
                                                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold"
                                                >
                                                    Clear
                                                </button>
                                                <button
                                                    onClick={() => { setShowPdfIngestion(false); setPdfPageItems([]); }}
                                                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* Close button when idle */}
                                    {!pdfProcessing && pdfPageItems.length === 0 && (
                                        <div className="flex justify-end">
                                            <button
                                                onClick={() => { setShowPdfIngestion(false); setPdfPageItems([]); }}
                                                className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold"
                                            >
                                                Close
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* GitHub Settings Modal */}
                        {showGitHubSettings && (
                            <div
                                className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
                                onClick={() => setShowGitHubSettings(false)}
                            >
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-md w-full"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <h2 className="text-2xl font-bold mb-4">â˜ï¸ GitHub Auto-Sync</h2>
                                    <p className="text-gray-600 mb-4 text-sm">Automatically sync changes to GitHub</p>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">GitHub Token</label>
                                            <input
                                                type="password"
                                                placeholder="ghp_xxxxxxxxxxxx"
                                                value={githubToken}
                                                onChange={(e) => setGithubToken(e.target.value)}
                                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Repository</label>
                                            <input
                                                type="text"
                                                placeholder="username/church-directory"
                                                value={githubRepo}
                                                onChange={(e) => setGithubRepo(e.target.value)}
                                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                                            />
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={saveGitHubConfig}
                                                className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700"
                                            >
                                                ðŸ’¾ Save & Test
                                            </button>
                                            <button
                                                onClick={() => setShowGitHubSettings(false)}
                                                className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-400"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Export Options Modal */}
                        {showExportOptions && (
                            <div
                                className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
                                onClick={() => setShowExportOptions(false)}
                            >
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-md w-full"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <h2 className="text-2xl font-bold mb-4">Export Directory</h2>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => { setShowExportOptions(false); exportExcel(); }}
                                            className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-left px-6"
                                        >
                                            <div>ðŸ“Š Excel Spreadsheet</div>
                                            <div className="text-sm text-green-100">Families + Members sheets</div>
                                        </button>
                                        <button
                                            onClick={() => { setShowExportOptions(false); exportPDF(); }}
                                            className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold text-left px-6"
                                        >
                                            <div>ðŸ“„ PDF Directory</div>
                                            <div className="text-sm text-red-100">Printable format</div>
                                        </button>
                                        <button
                                            onClick={() => { setShowExportOptions(false); exportEncrypted(); }}
                                            className="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold text-left px-6"
                                        >
                                            <div>ðŸ” Encrypted Backup</div>
                                            <div className="text-sm text-purple-100">Secure .enc file</div>
                                        </button>
                                        <button
                                            onClick={() => { setShowExportOptions(false); exportPlainJSON(); }}
                                            className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-left px-6"
                                        >
                                            <div>ðŸ“„ Plain JSON</div>
                                            <div className="text-sm text-blue-100">Unencrypted backup</div>
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setShowExportOptions(false)}
                                        className="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Admin Login Modal */}
                        {showAdminLogin && (
                            <div
                                className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
                                onClick={() => setShowAdminLogin(false)}
                            >
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-md w-full"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <h2 className="text-2xl font-bold mb-4">Admin Login</h2>
                                    <input
                                        type="password"
                                        placeholder="Enter PIN"
                                        value={adminPin}
                                        onChange={(e) => setAdminPin(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl mb-4"
                                    />
                                    <div className="flex gap-2">
                                        <button
                                            onClick={handleAdminLogin}
                                            className="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold"
                                        >
                                            Login
                                        </button>
                                        <button
                                            onClick={() => { setShowAdminLogin(false); setAdminPin(''); }}
                                            className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-xl font-bold"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Settings Modal */}
                        {showSettings && (
                            <div
                                className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
                                onClick={() => setShowSettings(false)}
                            >
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-md w-full"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <h2 className="text-2xl font-bold mb-6">Admin Settings</h2>
                                    <h3 className="text-lg font-bold mb-4">Change Admin PIN</h3>
                                    <div className="space-y-3 mb-6">
                                        <input
                                            type="password"
                                            placeholder="New PIN"
                                            value={newPin}
                                            onChange={(e) => setNewPin(e.target.value)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                                        />
                                        <input
                                            type="password"
                                            placeholder="Confirm PIN"
                                            value={confirmPin}
                                            onChange={(e) => setConfirmPin(e.target.value)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                                        />
                                        <button
                                            onClick={handleChangePIN}
                                            className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold"
                                        >
                                            Update PIN
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => { setShowSettings(false); setNewPin(''); setConfirmPin(''); }}
                                        className="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Edit Family Modal with Member Editing */}
                        {showEditFamily && editingFamily && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <h2 className="text-2xl font-bold mb-6">Edit Family #{editingFamily.familyNo}</h2>
                                    
                                    <div className="mb-6">
                                        <label className="block text-sm font-bold mb-2">Family Photo</label>
                                        <div className="flex items-center gap-4">
                                            {editingFamily.photo ? (
                                                <img src={editingFamily.photo} alt="Family" className="w-24 h-24 rounded-full object-cover" />
                                            ) : (
                                                <div className="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-3xl">ðŸ“·</div>
                                            )}
                                            <div>
                                                <input ref={fileInputRef} type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" />
                                                <button
                                                    onClick={() => fileInputRef.current?.click()}
                                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                                >
                                                    ðŸ“¸ Upload
                                                </button>
                                                {editingFamily.photo && (
                                                    <button
                                                        onClick={() => setEditingFamily({...editingFamily, photo: null})}
                                                        className="ml-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                                    >
                                                        ðŸ—‘ï¸
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid md:grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Head of Family *</label>
                                            <input
                                                type="text"
                                                value={editingFamily.headOfFamily || ''}
                                                onChange={(e) => setEditingFamily({...editingFamily, headOfFamily: e.target.value})}
                                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Prayer Group</label>
                                            <select
                                                value={editingFamily.prayerGroup || ''}
                                                onChange={(e) => setEditingFamily({...editingFamily, prayerGroup: e.target.value})}
                                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl"
                                            >
                                                <option value="">Select...</option>
                                                {prayerGroups.filter(g => g !== 'All').map(group => (
                                                    <option key={group} value={group}>{group}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Mobile</label>
                                            <input
                                                type="text"
                                                value={editingFamily.mobile || ''}
                                                onChange={(e) => setEditingFamily({...editingFamily, mobile: e.target.value})}
                                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Email</label>
                                            <input
                                                type="email"
                                                value={editingFamily.email || ''}
                                                onChange={(e) => setEditingFamily({...editingFamily, email: e.target.value})}
                                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl"
                                            />
                                        </div>
                                    </div>

                                    <div className="border-t-2 border-gray-200 pt-6 mt-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-xl font-bold">Family Members ({editingFamily.members?.length || 0})</h3>
                                            <button
                                                onClick={handleAddMember}
                                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                            >
                                                âž• Add Member
                                            </button>
                                        </div>

                                        {editingFamily.members && editingFamily.members.length > 0 ? (
                                            <div className="space-y-4">
                                                {editingFamily.members.map((member, index) => (
                                                    <div key={index} className="bg-gray-50 p-4 rounded-xl border-2 border-gray-200">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <h4 className="font-bold text-lg">Member {index + 1}</h4>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => setEditingMemberIndex(editingMemberIndex === index ? null : index)}
                                                                    className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm font-bold"
                                                                >
                                                                    {editingMemberIndex === index ? 'ðŸ“–' : 'âœï¸'}
                                                                </button>
                                                                <button
                                                                    onClick={() => handleDeleteMember(index)}
                                                                    onTouchEnd={(e) => { e.preventDefault(); handleDeleteMember(index); }}
                                                                    className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-bold"
                                                                >
                                                                    ðŸ—‘ï¸
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {editingMemberIndex === index ? (
                                                            <div className="grid md:grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Full Name *</label>
                                                                    <input type="text" value={member.name || ''} onChange={(e) => handleUpdateMember(index, 'name', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Pet Name</label>
                                                                    <input type="text" value={member.petName || ''} onChange={(e) => handleUpdateMember(index, 'petName', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Identity</label>
                                                                    <select value={member.identity || ''} onChange={(e) => handleUpdateMember(index, 'identity', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                                        <option value="">Select...</option>
                                                                        <option value="HOF">Head of Family</option>
                                                                        <option value="Wife">Wife</option>
                                                                        <option value="Son">Son</option>
                                                                        <option value="Daughter">Daughter</option>
                                                                        <option value="Father">Father</option>
                                                                        <option value="Mother">Mother</option>
                                                                        <option value="Other">Other</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Date of Birth</label>
                                                                    <input type="text" placeholder="DD/MM/YYYY" value={member.dob || ''} onChange={(e) => handleUpdateMember(index, 'dob', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Mobile</label>
                                                                    <input type="text" value={member.mobile || ''} onChange={(e) => handleUpdateMember(index, 'mobile', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Blood Group</label>
                                                                    <select value={member.bloodGroup || ''} onChange={(e) => handleUpdateMember(index, 'bloodGroup', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                                        <option value="">Select...</option>
                                                                        <option value="A+">A+</option>
                                                                        <option value="A-">A-</option>
                                                                        <option value="B+">B+</option>
                                                                        <option value="B-">B-</option>
                                                                        <option value="AB+">AB+</option>
                                                                        <option value="AB-">AB-</option>
                                                                        <option value="O+">O+</option>
                                                                        <option value="O-">O-</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">In Kuwait</label>
                                                                    <select value={member.inKwt || ''} onChange={(e) => handleUpdateMember(index, 'inKwt', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                                        <option value="">Select...</option>
                                                                        <option value="Yes">Yes</option>
                                                                        <option value="No">No</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Membership No</label>
                                                                    <input type="text" value={member.memNo || ''} onChange={(e) => handleUpdateMember(index, 'memNo', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="text-sm space-y-1">
                                                                <div><strong>Name:</strong> {member.name || 'Not set'} ({member.petName || 'No pet name'})</div>
                                                                <div><strong>Identity:</strong> {member.identity || 'Not set'}</div>
                                                                <div><strong>DOB:</strong> {member.dob || 'Not set'} {member.mobile && `â€¢ Mobile: ${member.mobile}`}</div>
                                                                {member.bloodGroup && <div><strong>Blood Group:</strong> {member.bloodGroup}</div>}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center text-gray-500 py-8">
                                                <p>No family members yet.</p>
                                                <p className="text-sm mt-2">Click "âž• Add Member" to add one.</p>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-2 mt-6">
                                        <button
                                            onClick={handleSaveFamily}
                                            className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold"
                                        >
                                            ðŸ’¾ Save All
                                        </button>
                                        <button
                                            onClick={() => { setShowEditFamily(false); setEditingFamily(null); setEditingMemberIndex(null); }}
                                            className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Family Detail Modal */}
                        {selectedFamily && (
                            <div
                                className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
                                onClick={() => setSelectedFamily(null)}
                            >
                                <div
                                    className="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto"
                                    onClick={(e) => e.stopPropagation()}
                                    onTouchEnd={(e) => e.stopPropagation()}
                                >
                                    <div className="flex gap-6 mb-6">
                                        {selectedFamily.photo && (
                                            <img src={selectedFamily.photo} alt={selectedFamily.headOfFamily} className="w-32 h-32 rounded-full object-cover border-4 border-purple-200" />
                                        )}
                                        <div className="flex-1">
                                            <div className="text-purple-600 text-sm font-bold">Family #{selectedFamily.familyNo}</div>
                                            <h2 className="text-3xl font-bold">{selectedFamily.headOfFamily}</h2>
                                            <div className="text-purple-600 font-bold mt-1">{selectedFamily.prayerGroup}</div>
                                        </div>
                                        <button
                                            onClick={() => setSelectedFamily(null)}
                                            className="text-gray-500 hover:text-gray-700 text-2xl"
                                        >
                                            Ã—
                                        </button>
                                    </div>
                                    <div className="space-y-3 text-sm">
                                        {selectedFamily.residentialAddress && <div><strong>Address:</strong> {selectedFamily.residentialAddress}</div>}
                                        {selectedFamily.mobile && <div><strong>Mobile:</strong> {selectedFamily.mobile}</div>}
                                        {selectedFamily.email && <div><strong>Email:</strong> {selectedFamily.email}</div>}
                                        {selectedFamily.members && selectedFamily.members.length > 0 && (
                                            <div>
                                                <strong className="block mb-2">Family Members:</strong>
                                                <div className="space-y-2">
                                                    {selectedFamily.members.map((member, idx) => (
                                                        <div key={idx} className="bg-gray-50 p-3 rounded-lg">
                                                            <div className="font-bold">{member.name} ({member.petName})</div>
                                                            <div className="text-xs text-gray-600">{member.identity} â€¢ DOB: {member.dob}{member.mobile && ` â€¢ ${member.mobile}`}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ChurchDirectory />, document.getElementById('root'));
    </script>
</body>
</html>
