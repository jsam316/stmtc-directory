<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St Thomas MTC Salmiya - Church Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(5deg); }
            66% { transform: translateY(-10px) rotate(-5deg); }
        }
        .floating-orb {
            animation: float 6s ease-in-out infinite;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        button, a, [role="button"] {
            touch-action: manipulation;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { jsPDF } = window.jspdf;

        // Encryption Library (same as before)
        class DirectoryCrypto {
            constructor() {
                this.algorithm = 'AES-GCM';
                this.keyLength = 256;
                this.iterations = 100000;
            }
            
            async deriveKey(password, salt) {
                const encoder = new TextEncoder();
                const passwordKey = await crypto.subtle.importKey('raw', encoder.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
                return await crypto.subtle.deriveKey({name: 'PBKDF2', salt: salt, iterations: this.iterations, hash: 'SHA-256'}, passwordKey, {name: this.algorithm, length: this.keyLength}, false, ['encrypt', 'decrypt']);
            }
            
            async encrypt(data, password) {
                const encoder = new TextEncoder();
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await this.deriveKey(password, salt);
                const encrypted = await crypto.subtle.encrypt({name: this.algorithm, iv: iv}, key, encoder.encode(JSON.stringify(data)));
                const combined = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.byteLength);
                combined.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);
                return btoa(String.fromCharCode(...combined));
            }
            
            async decrypt(encryptedBase64, password) {
                try {
                    const combined = new Uint8Array(atob(encryptedBase64).split('').map(c => c.charCodeAt(0)));
                    const salt = combined.slice(0, 16);
                    const iv = combined.slice(16, 28);
                    const encrypted = combined.slice(28);
                    const key = await this.deriveKey(password, salt);
                    const decrypted = await crypto.subtle.decrypt({name: this.algorithm, iv: iv}, key, encrypted);
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                } catch (error) {
                    throw new Error('Incorrect password or corrupted data');
                }
            }
            
            async loadEncryptedFile() {
                const paths = ['data/families.json.enc', './data/families.json.enc', 'families.json.enc', './families.json.enc'];
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) return await response.text();
                    } catch (error) {}
                }
                throw new Error('FILE_NOT_FOUND');
            }
        }

        const directoryCrypto = new DirectoryCrypto();

        // PIN Manager
        class PinManager {
            constructor() { this.defaultPin = '1234'; }
            getPin() { return localStorage.getItem('adminPin') || this.defaultPin; }
            setPin(newPin) { localStorage.setItem('adminPin', newPin); }
            verifyPin(pin) { return pin === this.getPin(); }
        }

        const pinManager = new PinManager();

        // Download Helper
        function downloadFile(content, filename, mimeType = 'text/plain') {
            try {
                const blob = new Blob([content], {type: mimeType});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                return true;
            } catch (error) {
                console.error('Download failed:', error);
                return false;
            }
        }

        // PDF Export
        function exportToPDF(families) {
            try {
                const doc = new jsPDF();
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('St Thomas MTC Salmiya, Kuwait', margin, yPos);
                yPos += 10;
                doc.setFontSize(14);
                doc.text('Church Directory', margin, yPos);
                yPos += 10;
                
                const sortedFamilies = [...families].sort((a, b) => (a.familyNo || '').localeCompare(b.familyNo || ''));
                
                sortedFamilies.forEach((family) => {
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`#${family.familyNo} - ${family.headOfFamily}`, margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    if (family.prayerGroup) { doc.text(`Prayer Group: ${family.prayerGroup}`, margin + 5, yPos); yPos += 5; }
                    if (family.mobile) { doc.text(`Mobile: ${family.mobile}`, margin + 5, yPos); yPos += 5; }
                    if (family.email) { doc.text(`Email: ${family.email}`, margin + 5, yPos); yPos += 5; }
                    
                    yPos += 3;
                    doc.line(margin, yPos, 190, yPos);
                    yPos += 5;
                });
                
                doc.save('church-directory.pdf');
                return true;
            } catch (error) {
                console.error('PDF failed:', error);
                return false;
            }
        }

        // Excel Export
        function exportToExcel(families) {
            try {
                const sortedFamilies = [...families].sort((a, b) => (a.familyNo || '').localeCompare(b.familyNo || ''));
                
                const familiesData = sortedFamilies.map(family => ({
                    'Family No': family.familyNo || '',
                    'Head of Family': family.headOfFamily || '',
                    'Prayer Group': family.prayerGroup || '',
                    'Mobile': family.mobile || '',
                    'Email': family.email || '',
                    'Address': family.residentialAddress || '',
                    'Total Members': family.members?.length || 0
                }));
                
                const membersData = [];
                sortedFamilies.forEach(family => {
                    if (family.members && family.members.length > 0) {
                        family.members.forEach(member => {
                            membersData.push({
                                'Family No': family.familyNo || '',
                                'Family': family.headOfFamily || '',
                                'Name': member.name || '',
                                'Pet Name': member.petName || '',
                                'Identity': member.identity || '',
                                'DOB': member.dob || '',
                                'Mobile': member.mobile || '',
                                'Blood Group': member.bloodGroup || ''
                            });
                        });
                    }
                });
                
                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.json_to_sheet(familiesData);
                const ws2 = XLSX.utils.json_to_sheet(membersData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Families');
                XLSX.utils.book_append_sheet(wb, ws2, 'Members');
                XLSX.writeFile(wb, 'church-directory.xlsx');
                return true;
            } catch (error) {
                console.error('Excel failed:', error);
                return false;
            }
        }

        // Image Helper
        function resizeImage(file, maxWidth = 400, maxHeight = 400) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        } else {
                            if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Main App
        function ChurchDirectory() {
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [password, setPassword] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [families, setFamilies] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPrayerGroup, setSelectedPrayerGroup] = useState('All');
            const [selectedFamily, setSelectedFamily] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPin, setAdminPin] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [showManualImport, setShowManualImport] = useState(false);
            const [importJson, setImportJson] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showExportOptions, setShowExportOptions] = useState(false);
            const [showEditFamily, setShowEditFamily] = useState(false);
            const [editingFamily, setEditingFamily] = useState(null);
            const [editingMemberIndex, setEditingMemberIndex] = useState(null);
            const [syncStatus, setSyncStatus] = useState('');
            const [loadingData, setLoadingData] = useState(false);
            const [newPin, setNewPin] = useState('');
            const [confirmPin, setConfirmPin] = useState('');
            const fileInputRef = useRef(null);

            useEffect(() => {
                const stored = localStorage.getItem('churchDirectory');
                const storedPassword = localStorage.getItem('directoryPassword');
                if (stored && storedPassword) {
                    try {
                        const data = JSON.parse(stored);
                        setFamilies(data);
                        setPassword(storedPassword);
                        setPasswordInput(storedPassword);
                    } catch (error) {
                        console.error('Failed to load stored data:', error);
                    }
                }
            }, []);

            const handleUnlock = async () => {
                if (!passwordInput) { alert('Please enter a password'); return; }
                setLoadingData(true);
                setSyncStatus('üîì Unlocking...');
                try {
                    const encryptedData = await directoryCrypto.loadEncryptedFile();
                    setSyncStatus('üîë Decrypting...');
                    const decryptedFamilies = await directoryCrypto.decrypt(encryptedData, passwordInput);
                    setFamilies(decryptedFamilies);
                    setPassword(passwordInput);
                    setIsUnlocked(true);
                    localStorage.setItem('churchDirectory', JSON.stringify(decryptedFamilies));
                    localStorage.setItem('directoryPassword', passwordInput);
                    setSyncStatus('‚úÖ Loaded ' + decryptedFamilies.length + ' families!');
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) {
                    if (error.message === 'FILE_NOT_FOUND') {
                        const result = confirm('‚ùå Could not find data file.\n\nImport manually?');
                        if (result) {
                            setPassword(passwordInput);
                            setIsUnlocked(true);
                            setShowManualImport(true);
                        }
                    } else if (error.message.includes('Incorrect password')) {
                        alert('‚ùå Incorrect password!');
                    } else {
                        alert('‚ùå Failed to load: ' + error.message);
                    }
                    setSyncStatus('');
                }
                setLoadingData(false);
            };

            const handleManualImport = () => {
                try {
                    const data = JSON.parse(importJson);
                    setFamilies(data);
                    localStorage.setItem('churchDirectory', JSON.stringify(data));
                    setSyncStatus('‚úÖ Imported ' + data.length + ' families!');
                    setShowManualImport(false);
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) {
                    alert('Invalid JSON: ' + error.message);
                }
            };

            const handleAdminLogin = () => {
                if (pinManager.verifyPin(adminPin)) {
                    setIsAdmin(true);
                    setShowAdminLogin(false);
                    setAdminPin('');
                } else {
                    alert('‚ùå Incorrect PIN');
                }
            };

            const handleChangePIN = () => {
                if (!newPin || !confirmPin) { alert('Please enter both PIN fields'); return; }
                if (newPin.length < 4) { alert('PIN must be at least 4 digits'); return; }
                if (newPin !== confirmPin) { alert('PINs do not match'); return; }
                pinManager.setPin(newPin);
                alert('‚úÖ PIN changed successfully!');
                setNewPin('');
                setConfirmPin('');
                setShowSettings(false);
            };

            const handlePhotoUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { alert('Please select an image file'); return; }
                try {
                    setSyncStatus('üì∏ Processing photo...');
                    const resizedPhoto = await resizeImage(file);
                    setEditingFamily({...editingFamily, photo: resizedPhoto});
                    setSyncStatus('‚úÖ Photo added!');
                    setTimeout(() => setSyncStatus(''), 2000);
                } catch (error) {
                    alert('Failed to process photo: ' + error.message);
                    setSyncStatus('');
                }
            };

            const handleEditFamily = (family) => {
                // Ensure members array exists
                if (!family.members) {
                    family.members = [];
                }
                setEditingFamily(family);
                setShowEditFamily(true);
            };

            const handleAddMember = () => {
                const newMember = {
                    name: '',
                    petName: '',
                    identity: '',
                    dob: '',
                    mobile: '',
                    bloodGroup: '',
                    inKwt: '',
                    memNo: ''
                };
                const updatedMembers = [...(editingFamily.members || []), newMember];
                setEditingFamily({...editingFamily, members: updatedMembers});
                setEditingMemberIndex(updatedMembers.length - 1);
            };

            const handleUpdateMember = (index, field, value) => {
                const updatedMembers = [...editingFamily.members];
                updatedMembers[index] = {...updatedMembers[index], [field]: value};
                setEditingFamily({...editingFamily, members: updatedMembers});
            };

            const handleDeleteMember = (index) => {
                if (confirm('Delete this family member?')) {
                    const updatedMembers = editingFamily.members.filter((_, i) => i !== index);
                    setEditingFamily({...editingFamily, members: updatedMembers});
                    if (editingMemberIndex === index) {
                        setEditingMemberIndex(null);
                    }
                }
            };

            const handleSaveFamily = () => {
                if (!editingFamily.headOfFamily) { alert('Please enter head of family name'); return; }
                const updated = [...families];
                const index = updated.findIndex(f => f.familyNo === editingFamily.familyNo);
                if (index >= 0) {
                    updated[index] = editingFamily;
                } else {
                    updated.push(editingFamily);
                }
                setFamilies(updated);
                localStorage.setItem('churchDirectory', JSON.stringify(updated));
                setSyncStatus('‚úÖ Saved!');
                setTimeout(() => setSyncStatus(''), 2000);
                setShowEditFamily(false);
                setEditingFamily(null);
                setEditingMemberIndex(null);
            };

            const exportEncrypted = async () => {
                try {
                    if (!password) { alert('‚ùå Password not available'); return; }
                    setSyncStatus('üì¶ Encrypting...');
                    const encrypted = await directoryCrypto.encrypt(families, password);
                    setSyncStatus('üíæ Downloading...');
                    const success = downloadFile(encrypted, 'families.json.enc', 'text/plain');
                    if (success) {
                        setSyncStatus('‚úÖ Downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) {
                    alert('‚ùå Export failed: ' + error.message);
                }
            };

            const exportPlainJSON = () => {
                try {
                    setSyncStatus('üì¶ Preparing...');
                    const jsonString = JSON.stringify(families, null, 2);
                    const success = downloadFile(jsonString, 'families-backup.json', 'application/json');
                    if (success) {
                        setSyncStatus('‚úÖ Downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) {
                    alert('‚ùå Export failed: ' + error.message);
                }
            };

            const exportPDF = () => {
                try {
                    setSyncStatus('üìÑ Generating PDF...');
                    const success = exportToPDF(families);
                    if (success) {
                        setSyncStatus('‚úÖ PDF downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    } else {
                        throw new Error('PDF generation failed');
                    }
                } catch (error) {
                    alert('‚ùå PDF failed: ' + error.message);
                }
            };

            const exportExcel = () => {
                try {
                    setSyncStatus('üìä Generating Excel...');
                    const success = exportToExcel(families);
                    if (success) {
                        setSyncStatus('‚úÖ Excel downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    } else {
                        throw new Error('Excel generation failed');
                    }
                } catch (error) {
                    alert('‚ùå Excel failed: ' + error.message);
                }
            };

            const filteredFamilies = useMemo(() => {
                return families.filter(family => {
                    const matchesSearch = searchTerm === '' || 
                        family.headOfFamily?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        family.familyNo?.includes(searchTerm);
                    const matchesPrayerGroup = selectedPrayerGroup === 'All' || family.prayerGroup === selectedPrayerGroup;
                    return matchesSearch && matchesPrayerGroup;
                });
            }, [families, searchTerm, selectedPrayerGroup]);

            const prayerGroups = useMemo(() => {
                const groups = new Set(families.map(f => f.prayerGroup).filter(Boolean));
                return ['All', ...Array.from(groups).sort()];
            }, [families]);

            // Login Screen
            if (!isUnlocked) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-4 relative overflow-hidden">
                        <div className="glass-effect rounded-3xl p-12 max-w-md w-full shadow-2xl relative z-10">
                            <h1 className="text-4xl font-black text-white text-center mb-2">St Thomas MTC</h1>
                            <p className="text-white/80 text-center mb-8">Salmiya, Kuwait</p>
                            {loadingData ? (
                                <div className="text-center">
                                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-white mx-auto mb-4"></div>
                                    <p className="text-white">{syncStatus}</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <input type="password" placeholder="Enter password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleUnlock()} className="w-full px-6 py-4 rounded-xl bg-white/10 border-2 border-white/30 text-white placeholder-white/50 focus:outline-none focus:border-white/60" />
                                    <button onClick={handleUnlock} className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 rounded-xl shadow-lg">üîì Unlock Directory</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Manual Import Screen
            if (showManualImport) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl p-8 max-w-4xl w-full">
                            <h2 className="text-2xl font-bold mb-4">Manual Data Import</h2>
                            <textarea value={importJson} onChange={(e) => setImportJson(e.target.value)} placeholder='[{"familyNo":"001",...}]' className="w-full h-96 p-4 border-2 border-gray-300 rounded-xl font-mono text-sm mb-4" />
                            <div className="flex gap-2">
                                <button onClick={handleManualImport} className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Import</button>
                                <button onClick={() => setShowManualImport(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold">Cancel</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main View
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-3xl p-6 mb-6 shadow-2xl">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-black text-white">St Thomas MTC</h1>
                                    <p className="text-white/90 mt-1">{families.length} Families</p>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {!isAdmin ? (
                                        <button onClick={() => setShowAdminLogin(true)} className="bg-white text-purple-700 px-6 py-3 rounded-xl font-bold hover:bg-white/90">üîê Admin</button>
                                    ) : (
                                        <>
                                            <button onClick={() => setShowSettings(true)} className="bg-white/20 text-white px-4 py-3 rounded-xl font-bold hover:bg-white/30">‚öôÔ∏è</button>
                                            <button onClick={() => setShowManualImport(true)} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700">üì•</button>
                                            <button onClick={() => setShowExportOptions(true)} className="bg-yellow-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-yellow-700">üì§</button>
                                        </>
                                    )}
                                </div>
                            </div>
                            {syncStatus && <div className="mt-4 bg-white/20 rounded-xl p-3 text-white font-bold text-center">{syncStatus}</div>}
                        </div>

                        {/* Search */}
                        <div className="glass-effect rounded-3xl p-6 mb-6 shadow-xl">
                            <div className="grid md:grid-cols-2 gap-4">
                                <input type="text" placeholder="üîç Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="px-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 focus:outline-none" />
                                <select value={selectedPrayerGroup} onChange={(e) => setSelectedPrayerGroup(e.target.value)} className="px-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 focus:outline-none">
                                    {prayerGroups.map(group => <option key={group} value={group}>{group}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* Family Cards */}
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredFamilies.map(family => (
                                <div key={family.familyNo} onClick={() => setSelectedFamily(family)} className="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all cursor-pointer transform hover:scale-105">
                                    <div className="flex gap-4 mb-3">
                                        {family.photo ? (
                                            <img src={family.photo} alt={family.headOfFamily} className="w-16 h-16 rounded-full object-cover border-2 border-white" />
                                        ) : (
                                            <div className="w-16 h-16 rounded-full bg-purple-500/50 flex items-center justify-center text-white text-2xl font-bold">{family.headOfFamily?.charAt(0) || '?'}</div>
                                        )}
                                        <div className="flex-1">
                                            <div className="text-purple-200 text-sm font-bold">#{family.familyNo}</div>
                                            <h3 className="text-white text-xl font-bold mt-1">{family.headOfFamily}</h3>
                                            <div className="bg-purple-500/50 inline-block px-3 py-1 rounded-lg text-white text-xs font-bold mt-1">{family.prayerGroup}</div>
                                        </div>
                                    </div>
                                    <div className="space-y-2 text-white/80 text-sm">
                                        {family.mobile && <div>üì± {family.mobile}</div>}
                                        {family.email && <div className="truncate">‚úâÔ∏è {family.email}</div>}
                                        <div>üë• {family.members?.length || 0} members</div>
                                    </div>
                                    {isAdmin && (
                                        <button onClick={(e) => { e.stopPropagation(); handleEditFamily(family); }} className="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-xl text-sm font-bold">‚úèÔ∏è Edit</button>
                                    )}
                                </div>
                            ))}
                        </div>

                        {filteredFamilies.length === 0 && (
                            <div className="glass-effect rounded-3xl p-12 text-center">
                                <p className="text-white/80 text-xl">{families.length === 0 ? 'No families loaded' : 'No families found'}</p>
                            </div>
                        )}

                        {/* Export Options Modal (same as before) */}
                        {showExportOptions && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowExportOptions(false)}>
                                <div className="bg-white rounded-2xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                    <h2 className="text-2xl font-bold mb-4">Export Directory</h2>
                                    <div className="space-y-3">
                                        <button onClick={() => { setShowExportOptions(false); exportExcel(); }} className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div>üìä Excel Spreadsheet</div>
                                            <div className="text-sm text-green-100">Families + Members sheets</div>
                                        </button>
                                        <button onClick={() => { setShowExportOptions(false); exportPDF(); }} className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div>üìÑ PDF Directory</div>
                                            <div className="text-sm text-red-100">Printable format</div>
                                        </button>
                                        <button onClick={() => { setShowExportOptions(false); exportEncrypted(); }} className="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div>üîê Encrypted Backup</div>
                                            <div className="text-sm text-purple-100">Secure .enc file</div>
                                        </button>
                                        <button onClick={() => { setShowExportOptions(false); exportPlainJSON(); }} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div>üìÑ Plain JSON</div>
                                            <div className="text-sm text-blue-100">Unencrypted backup</div>
                                        </button>
                                    </div>
                                    <button onClick={() => setShowExportOptions(false)} className="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold">Cancel</button>
                                </div>
                            </div>
                        )}

                        {/* ENHANCED Edit Family Modal with Member Editing */}
                        {showEditFamily && editingFamily && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div className="bg-white rounded-2xl p-8 max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                    <h2 className="text-2xl font-bold mb-6">Edit Family #{editingFamily.familyNo}</h2>
                                    
                                    {/* Family Photo */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-bold mb-2">Family Photo</label>
                                        <div className="flex items-center gap-4">
                                            {editingFamily.photo ? (
                                                <img src={editingFamily.photo} alt="Family" className="w-24 h-24 rounded-full object-cover" />
                                            ) : (
                                                <div className="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-3xl">üì∑</div>
                                            )}
                                            <div>
                                                <input ref={fileInputRef} type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" />
                                                <button onClick={() => fileInputRef.current?.click()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm">üì∏ Upload</button>
                                                {editingFamily.photo && <button onClick={() => setEditingFamily({...editingFamily, photo: null})} className="ml-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-bold text-sm">üóëÔ∏è</button>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Basic Family Info */}
                                    <div className="grid md:grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Head of Family *</label>
                                            <input type="text" value={editingFamily.headOfFamily || ''} onChange={(e) => setEditingFamily({...editingFamily, headOfFamily: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Prayer Group</label>
                                            <select value={editingFamily.prayerGroup || ''} onChange={(e) => setEditingFamily({...editingFamily, prayerGroup: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl">
                                                <option value="">Select...</option>
                                                {prayerGroups.filter(g => g !== 'All').map(group => <option key={group} value={group}>{group}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Mobile</label>
                                            <input type="text" value={editingFamily.mobile || ''} onChange={(e) => setEditingFamily({...editingFamily, mobile: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Email</label>
                                            <input type="email" value={editingFamily.email || ''} onChange={(e) => setEditingFamily({...editingFamily, email: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl" />
                                        </div>
                                    </div>

                                    {/* FAMILY MEMBERS SECTION */}
                                    <div className="border-t-2 border-gray-200 pt-6 mt-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-xl font-bold">Family Members ({editingFamily.members?.length || 0})</h3>
                                            <button onClick={handleAddMember} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm">‚ûï Add Member</button>
                                        </div>

                                        {editingFamily.members && editingFamily.members.length > 0 ? (
                                            <div className="space-y-4">
                                                {editingFamily.members.map((member, index) => (
                                                    <div key={index} className="bg-gray-50 p-4 rounded-xl border-2 border-gray-200">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <h4 className="font-bold text-lg">Member {index + 1}</h4>
                                                            <div className="flex gap-2">
                                                                <button onClick={() => setEditingMemberIndex(editingMemberIndex === index ? null : index)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm font-bold">
                                                                    {editingMemberIndex === index ? 'üìñ Collapse' : '‚úèÔ∏è Edit'}
                                                                </button>
                                                                <button onClick={() => handleDeleteMember(index)} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-bold">üóëÔ∏è</button>
                                                            </div>
                                                        </div>

                                                        {editingMemberIndex === index ? (
                                                            // Edit mode
                                                            <div className="grid md:grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Full Name *</label>
                                                                    <input type="text" value={member.name || ''} onChange={(e) => handleUpdateMember(index, 'name', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Pet Name</label>
                                                                    <input type="text" value={member.petName || ''} onChange={(e) => handleUpdateMember(index, 'petName', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Identity</label>
                                                                    <select value={member.identity || ''} onChange={(e) => handleUpdateMember(index, 'identity', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                                        <option value="">Select...</option>
                                                                        <option value="HOF">Head of Family</option>
                                                                        <option value="Wife">Wife</option>
                                                                        <option value="Son">Son</option>
                                                                        <option value="Daughter">Daughter</option>
                                                                        <option value="Father">Father</option>
                                                                        <option value="Mother">Mother</option>
                                                                        <option value="Other">Other</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Date of Birth</label>
                                                                    <input type="text" placeholder="DD/MM/YYYY" value={member.dob || ''} onChange={(e) => handleUpdateMember(index, 'dob', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Mobile</label>
                                                                    <input type="text" value={member.mobile || ''} onChange={(e) => handleUpdateMember(index, 'mobile', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Blood Group</label>
                                                                    <select value={member.bloodGroup || ''} onChange={(e) => handleUpdateMember(index, 'bloodGroup', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                                        <option value="">Select...</option>
                                                                        <option value="A+">A+</option>
                                                                        <option value="A-">A-</option>
                                                                        <option value="B+">B+</option>
                                                                        <option value="B-">B-</option>
                                                                        <option value="AB+">AB+</option>
                                                                        <option value="AB-">AB-</option>
                                                                        <option value="O+">O+</option>
                                                                        <option value="O-">O-</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">In Kuwait</label>
                                                                    <select value={member.inKwt || ''} onChange={(e) => handleUpdateMember(index, 'inKwt', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                                        <option value="">Select...</option>
                                                                        <option value="Yes">Yes</option>
                                                                        <option value="No">No</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-bold mb-1">Membership No</label>
                                                                    <input type="text" value={member.memNo || ''} onChange={(e) => handleUpdateMember(index, 'memNo', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            // View mode
                                                            <div className="text-sm space-y-1">
                                                                <div><strong>Name:</strong> {member.name || 'Not set'} ({member.petName || 'No pet name'})</div>
                                                                <div><strong>Identity:</strong> {member.identity || 'Not set'}</div>
                                                                <div><strong>DOB:</strong> {member.dob || 'Not set'} {member.mobile && `‚Ä¢ Mobile: ${member.mobile}`}</div>
                                                                {member.bloodGroup && <div><strong>Blood Group:</strong> {member.bloodGroup}</div>}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center text-gray-500 py-8">
                                                <p>No family members added yet.</p>
                                                <p className="text-sm mt-2">Click "‚ûï Add Member" to add the first member.</p>
                                            </div>
                                        )}
                                    </div>

                                    {/* Save/Cancel Buttons */}
                                    <div className="flex gap-2 mt-6">
                                        <button onClick={handleSaveFamily} className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">üíæ Save All Changes</button>
                                        <button onClick={() => { setShowEditFamily(false); setEditingFamily(null); setEditingMemberIndex(null); }} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Admin Login Modal (same as before) */}
                        {showAdminLogin && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowAdminLogin(false)}>
                                <div className="bg-white rounded-2xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                    <h2 className="text-2xl font-bold mb-4">Admin Login</h2>
                                    <input type="password" placeholder="Enter PIN" value={adminPin} onChange={(e) => setAdminPin(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()} className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl mb-4" />
                                    <div className="flex gap-2">
                                        <button onClick={handleAdminLogin} className="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold">Login</button>
                                        <button onClick={() => { setShowAdminLogin(false); setAdminPin(''); }} className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-xl font-bold">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Settings Modal (same as before) */}
                        {showSettings && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowSettings(false)}>
                                <div className="bg-white rounded-2xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                    <h2 className="text-2xl font-bold mb-6">Admin Settings</h2>
                                    <h3 className="text-lg font-bold mb-4">Change Admin PIN</h3>
                                    <div className="space-y-3 mb-6">
                                        <input type="password" placeholder="New PIN" value={newPin} onChange={(e) => setNewPin(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl" />
                                        <input type="password" placeholder="Confirm PIN" value={confirmPin} onChange={(e) => setConfirmPin(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl" />
                                        <button onClick={handleChangePIN} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Update PIN</button>
                                    </div>
                                    <button onClick={() => { setShowSettings(false); setNewPin(''); setConfirmPin(''); }} className="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold">Close</button>
                                </div>
                            </div>
                        )}

                        {/* Family Detail Modal (same as before) */}
                        {selectedFamily && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setSelectedFamily(null)}>
                                <div className="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                    <div className="flex gap-6 mb-6">
                                        {selectedFamily.photo && <img src={selectedFamily.photo} alt={selectedFamily.headOfFamily} className="w-32 h-32 rounded-full object-cover border-4 border-purple-200" />}
                                        <div className="flex-1">
                                            <div className="text-purple-600 text-sm font-bold">Family #{selectedFamily.familyNo}</div>
                                            <h2 className="text-3xl font-bold">{selectedFamily.headOfFamily}</h2>
                                            <div className="text-purple-600 font-bold mt-1">{selectedFamily.prayerGroup}</div>
                                        </div>
                                        <button onClick={() => setSelectedFamily(null)} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                                    </div>
                                    <div className="space-y-3 text-sm">
                                        {selectedFamily.residentialAddress && <div><strong>Address:</strong> {selectedFamily.residentialAddress}</div>}
                                        {selectedFamily.mobile && <div><strong>Mobile:</strong> {selectedFamily.mobile}</div>}
                                        {selectedFamily.email && <div><strong>Email:</strong> {selectedFamily.email}</div>}
                                        {selectedFamily.members && selectedFamily.members.length > 0 && (
                                            <div>
                                                <strong className="block mb-2">Family Members:</strong>
                                                <div className="space-y-2">
                                                    {selectedFamily.members.map((member, idx) => (
                                                        <div key={idx} className="bg-gray-50 p-3 rounded-lg">
                                                            <div className="font-bold">{member.name} ({member.petName})</div>
                                                            <div className="text-xs text-gray-600">{member.identity} ‚Ä¢ DOB: {member.dob}{member.mobile && ` ‚Ä¢ ${member.mobile}`}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ChurchDirectory />, document.getElementById('root'));
    </script>
</body>
</html>
