<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St Thomas MTC Salmiya, Kuwait - Church Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(5deg); }
            66% { transform: translateY(-10px) rotate(-5deg); }
        }
        .floating-orb {
            animation: float 6s ease-in-out infinite;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { jsPDF } = window.jspdf;

        // ============================================
        // ENCRYPTION LIBRARY (abbreviated for space)
        // ============================================
        class DirectoryCrypto {
            constructor() {
                this.algorithm = 'AES-GCM';
                this.keyLength = 256;
                this.iterations = 100000;
            }
            
            async deriveKey(password, salt) {
                const encoder = new TextEncoder();
                const passwordKey = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                return await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: this.iterations,
                        hash: 'SHA-256'
                    },
                    passwordKey,
                    { name: this.algorithm, length: this.keyLength },
                    false,
                    ['encrypt', 'decrypt']
                );
            }
            
            async encrypt(data, password) {
                const encoder = new TextEncoder();
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await this.deriveKey(password, salt);
                
                const encrypted = await crypto.subtle.encrypt(
                    { name: this.algorithm, iv: iv },
                    key,
                    encoder.encode(JSON.stringify(data))
                );
                
                const combined = new Uint8Array(
                    salt.byteLength + iv.byteLength + encrypted.byteLength
                );
                combined.set(salt, 0);
                combined.set(iv, salt.byteLength);
                combined.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);
                
                return btoa(String.fromCharCode(...combined));
            }
            
            async decrypt(encryptedBase64, password) {
                try {
                    const combined = new Uint8Array(
                        atob(encryptedBase64).split('').map(c => c.charCodeAt(0))
                    );
                    
                    const salt = combined.slice(0, 16);
                    const iv = combined.slice(16, 28);
                    const encrypted = combined.slice(28);
                    const key = await this.deriveKey(password, salt);
                    
                    const decrypted = await crypto.subtle.decrypt(
                        { name: this.algorithm, iv: iv },
                        key,
                        encrypted
                    );
                    
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                } catch (error) {
                    throw new Error('Incorrect password or corrupted data');
                }
            }
            
            async loadEncryptedFile() {
                const paths = [
                    'data/families.json.enc',
                    './data/families.json.enc',
                    'families.json.enc',
                    './families.json.enc'
                ];
                
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            return await response.text();
                        }
                    } catch (error) {
                        // Continue to next path
                    }
                }
                
                throw new Error('FILE_NOT_FOUND');
            }
        }

        const directoryCrypto = new DirectoryCrypto();

        // ============================================
        // GITHUB AUTO-SYNC (abbreviated)
        // ============================================
        class GitHubSync {
            constructor() {
                this.token = null;
                this.repo = null;
                this.branch = 'main';
                this.filePath = 'data/families.json.enc';
                this.loadConfig();
            }
            
            loadConfig() {
                try {
                    const config = localStorage.getItem('githubSyncConfig');
                    if (config) {
                        const parsed = JSON.parse(config);
                        this.token = parsed.token;
                        this.repo = parsed.repo;
                        this.branch = parsed.branch || 'main';
                        this.filePath = parsed.filePath || 'data/families.json.enc';
                    }
                } catch (error) {
                    console.error('Failed to load GitHub config:', error);
                }
            }
            
            saveConfig(token, repo, branch = 'main', filePath = 'data/families.json.enc') {
                this.token = token;
                this.repo = repo;
                this.branch = branch;
                this.filePath = filePath;
                localStorage.setItem('githubSyncConfig', JSON.stringify({ token, repo, branch, filePath }));
                return true;
            }
            
            isConfigured() {
                return !!(this.token && this.repo);
            }
            
            async testConnection() {
                if (!this.isConfigured()) throw new Error('GitHub not configured');
                const response = await fetch(`https://api.github.com/repos/${this.repo}`, {
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) throw new Error(response.status === 401 ? 'Invalid token' : 'Repository not found');
                return await response.json();
            }
            
            async getFileSHA() {
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${this.repo}/contents/${this.filePath}?ref=${this.branch}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        return data.sha;
                    }
                    return null;
                } catch (error) {
                    return null;
                }
            }
            
            async uploadData(encryptedData, commitMessage = null) {
                if (!this.isConfigured()) throw new Error('GitHub not configured');
                const sha = await this.getFileSHA();
                if (!commitMessage) {
                    const now = new Date();
                    commitMessage = `Updated directory - ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                }
                const body = {
                    message: commitMessage,
                    content: btoa(encryptedData),
                    branch: this.branch
                };
                if (sha) body.sha = sha;
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.repo}/contents/${this.filePath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Upload failed');
                }
                return await response.json();
            }
        }

        const githubSync = new GitHubSync();

        // ============================================
        // PIN MANAGEMENT
        // ============================================
        class PinManager {
            constructor() {
                this.defaultPin = '1234';
            }
            
            getPin() {
                const stored = localStorage.getItem('adminPin');
                return stored || this.defaultPin;
            }
            
            setPin(newPin) {
                localStorage.setItem('adminPin', newPin);
            }
            
            verifyPin(pin) {
                return pin === this.getPin();
            }
        }

        const pinManager = new PinManager();

        // ============================================
        // DOWNLOAD HELPER
        // ============================================
        function downloadFile(content, filename, mimeType = 'text/plain') {
            try {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                return true;
            } catch (error) {
                console.error('Download failed:', error);
                return false;
            }
        }

        // ============================================
        // PDF EXPORT FUNCTION
        // ============================================
        function exportToPDF(families) {
            try {
                const doc = new jsPDF();
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('St Thomas MTC Salmiya, Kuwait', margin, yPos);
                yPos += 10;
                doc.setFontSize(14);
                doc.text('Church Directory', margin, yPos);
                yPos += 5;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, yPos);
                yPos += 10;
                
                const sortedFamilies = [...families].sort((a, b) => 
                    (a.familyNo || '').localeCompare(b.familyNo || '')
                );
                
                sortedFamilies.forEach((family, index) => {
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`#${family.familyNo} - ${family.headOfFamily}`, margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    if (family.prayerGroup) {
                        doc.text(`Prayer Group: ${family.prayerGroup}`, margin + 5, yPos);
                        yPos += 5;
                    }
                    
                    if (family.mobile) {
                        doc.text(`Mobile: ${family.mobile}`, margin + 5, yPos);
                        yPos += 5;
                    }
                    if (family.telephone) {
                        doc.text(`Telephone: ${family.telephone}`, margin + 5, yPos);
                        yPos += 5;
                    }
                    if (family.email) {
                        doc.text(`Email: ${family.email}`, margin + 5, yPos);
                        yPos += 5;
                    }
                    
                    if (family.residentialAddress) {
                        const addressLines = doc.splitTextToSize(`Address: ${family.residentialAddress}`, 170);
                        doc.text(addressLines, margin + 5, yPos);
                        yPos += (addressLines.length * 5);
                    }
                    
                    if (family.members && family.members.length > 0) {
                        doc.text(`Members: ${family.members.length}`, margin + 5, yPos);
                        yPos += 5;
                    }
                    
                    yPos += 3;
                    doc.line(margin, yPos, 190, yPos);
                    yPos += 5;
                });
                
                doc.save('church-directory.pdf');
                return true;
            } catch (error) {
                console.error('PDF generation failed:', error);
                return false;
            }
        }

        // ============================================
        // EXCEL EXPORT FUNCTION (NEW!)
        // ============================================
        function exportToExcel(families) {
            try {
                // Sort families by family number
                const sortedFamilies = [...families].sort((a, b) => 
                    (a.familyNo || '').localeCompare(b.familyNo || '')
                );
                
                // Create main families sheet
                const familiesData = sortedFamilies.map(family => ({
                    'Family No': family.familyNo || '',
                    'Head of Family': family.headOfFamily || '',
                    'Prayer Group': family.prayerGroup || '',
                    'Mobile': family.mobile || '',
                    'Telephone': family.telephone || '',
                    'Email': family.email || '',
                    'Residential Address': family.residentialAddress || '',
                    'Permanent Address': family.permanentAddress || '',
                    'Mother Parish': family.motherParish || '',
                    'Date of Marriage': family.dateOfMarriage || '',
                    'Emergency Contact': family.emergencyContact || '',
                    'Total Members': family.members?.length || 0
                }));
                
                // Create members sheet
                const membersData = [];
                sortedFamilies.forEach(family => {
                    if (family.members && family.members.length > 0) {
                        family.members.forEach(member => {
                            membersData.push({
                                'Family No': family.familyNo || '',
                                'Family Name': family.headOfFamily || '',
                                'Member Name': member.name || '',
                                'Pet Name': member.petName || '',
                                'Identity': member.identity || '',
                                'Date of Birth': member.dob || '',
                                'Mobile': member.mobile || '',
                                'Blood Group': member.bloodGroup || '',
                                'In Kuwait': member.inKwt || '',
                                'Membership No': member.memNo || ''
                            });
                        });
                    }
                });
                
                // Create prayer groups summary
                const prayerGroupStats = {};
                sortedFamilies.forEach(family => {
                    const group = family.prayerGroup || 'Unknown';
                    if (!prayerGroupStats[group]) {
                        prayerGroupStats[group] = 0;
                    }
                    prayerGroupStats[group]++;
                });
                
                const summaryData = Object.entries(prayerGroupStats)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([group, count]) => ({
                        'Prayer Group': group,
                        'Number of Families': count
                    }));
                
                // Add totals
                summaryData.push({
                    'Prayer Group': 'TOTAL',
                    'Number of Families': sortedFamilies.length
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add families sheet
                const ws1 = XLSX.utils.json_to_sheet(familiesData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Families');
                
                // Add members sheet
                const ws2 = XLSX.utils.json_to_sheet(membersData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Family Members');
                
                // Add summary sheet
                const ws3 = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws3, 'Summary');
                
                // Set column widths
                const wscols = [
                    {wch: 10}, // Family No
                    {wch: 25}, // Head of Family
                    {wch: 15}, // Prayer Group
                    {wch: 15}, // Mobile
                    {wch: 15}, // Telephone
                    {wch: 25}, // Email
                    {wch: 40}, // Address
                    {wch: 40}, // Permanent Address
                    {wch: 20}, // Mother Parish
                    {wch: 15}, // Date of Marriage
                    {wch: 20}, // Emergency Contact
                    {wch: 12}  // Total Members
                ];
                ws1['!cols'] = wscols;
                
                // Generate and download
                XLSX.writeFile(wb, 'church-directory.xlsx');
                return true;
            } catch (error) {
                console.error('Excel export failed:', error);
                return false;
            }
        }

        // ============================================
        // IMAGE HELPER
        // ============================================
        function resizeImage(file, maxWidth = 400, maxHeight = 400) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ============================================
        // MAIN APP (abbreviated for space - same structure as before)
        // Key additions: exportToExcel function and new export button
        // ============================================
        function ChurchDirectory() {
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [password, setPassword] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [families, setFamilies] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPrayerGroup, setSelectedPrayerGroup] = useState('All');
            const [selectedFamily, setSelectedFamily] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPin, setAdminPin] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [showManualImport, setShowManualImport] = useState(false);
            const [importJson, setImportJson] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showGitHubSettings, setShowGitHubSettings] = useState(false);
            const [showExportOptions, setShowExportOptions] = useState(false);
            const [showEditFamily, setShowEditFamily] = useState(false);
            const [editingFamily, setEditingFamily] = useState(null);
            const [syncStatus, setSyncStatus] = useState('');
            const [loadingData, setLoadingData] = useState(false);
            const [githubToken, setGithubToken] = useState('');
            const [githubRepo, setGithubRepo] = useState('');
            const [newPin, setNewPin] = useState('');
            const [confirmPin, setConfirmPin] = useState('');
            const fileInputRef = useRef(null);

            useEffect(() => {
                const stored = localStorage.getItem('churchDirectory');
                const storedPassword = localStorage.getItem('directoryPassword');
                if (stored && storedPassword) {
                    try {
                        const data = JSON.parse(stored);
                        setFamilies(data);
                        setPassword(storedPassword);
                        setPasswordInput(storedPassword);
                    } catch (error) {
                        console.error('Failed to load stored data:', error);
                    }
                }
            }, []);

            const handleUnlock = async () => {
                if (!passwordInput) {
                    alert('Please enter a password');
                    return;
                }
                
                setLoadingData(true);
                setSyncStatus('üîì Unlocking and loading data...');
                
                try {
                    const encryptedData = await directoryCrypto.loadEncryptedFile();
                    setSyncStatus('üîë Decrypting data...');
                    const decryptedFamilies = await directoryCrypto.decrypt(encryptedData, passwordInput);
                    
                    setFamilies(decryptedFamilies);
                    setPassword(passwordInput);
                    setIsUnlocked(true);
                    
                    localStorage.setItem('churchDirectory', JSON.stringify(decryptedFamilies));
                    localStorage.setItem('directoryPassword', passwordInput);
                    
                    setSyncStatus('‚úÖ Loaded ' + decryptedFamilies.length + ' families!');
                    setTimeout(() => setSyncStatus(''), 3000);
                    
                } catch (error) {
                    setLoadingData(false);
                    
                    if (error.message === 'FILE_NOT_FOUND') {
                        const result = confirm('‚ùå Could not find encrypted data file.\n\nWould you like to import data manually?');
                        if (result) {
                            setPassword(passwordInput);
                            setIsUnlocked(true);
                            setShowManualImport(true);
                        }
                    } else if (error.message.includes('Incorrect password')) {
                        alert('‚ùå Incorrect password!');
                    } else {
                        alert('‚ùå Failed to load directory: ' + error.message);
                    }
                    setSyncStatus('');
                }
                
                setLoadingData(false);
            };

            const handleManualImport = () => {
                try {
                    const data = JSON.parse(importJson);
                    setFamilies(data);
                    localStorage.setItem('churchDirectory', JSON.stringify(data));
                    setSyncStatus('‚úÖ Imported ' + data.length + ' families!');
                    setShowManualImport(false);
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) {
                    alert('Invalid JSON: ' + error.message);
                }
            };

            const handleAdminLogin = () => {
                if (pinManager.verifyPin(adminPin)) {
                    setIsAdmin(true);
                    setShowAdminLogin(false);
                    setAdminPin('');
                } else {
                    alert('‚ùå Incorrect PIN');
                }
            };

            const handleChangePIN = () => {
                if (!newPin || !confirmPin) {
                    alert('Please enter both PIN fields');
                    return;
                }
                if (newPin.length < 4) {
                    alert('PIN must be at least 4 digits');
                    return;
                }
                if (newPin !== confirmPin) {
                    alert('PINs do not match');
                    return;
                }
                pinManager.setPin(newPin);
                alert('‚úÖ PIN changed successfully!');
                setNewPin('');
                setConfirmPin('');
                setShowSettings(false);
            };

            const saveChanges = async (updatedFamilies) => {
                try {
                    setSyncStatus('üíæ Saving...');
                    localStorage.setItem('churchDirectory', JSON.stringify(updatedFamilies));
                    setFamilies(updatedFamilies);
                    
                    if (githubSync.isConfigured() && password) {
                        setSyncStatus('‚òÅÔ∏è Syncing to GitHub...');
                        const encrypted = await directoryCrypto.encrypt(updatedFamilies, password);
                        await githubSync.uploadData(encrypted);
                        setSyncStatus('‚úÖ Saved and published!');
                    } else {
                        setSyncStatus('‚úÖ Saved locally');
                    }
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) {
                    setSyncStatus('‚ùå Error: ' + error.message);
                    console.error('Save error:', error);
                }
            };

            const handlePhotoUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    return;
                }
                
                try {
                    setSyncStatus('üì∏ Processing photo...');
                    const resizedPhoto = await resizeImage(file);
                    
                    const updatedFamily = {
                        ...editingFamily,
                        photo: resizedPhoto
                    };
                    setEditingFamily(updatedFamily);
                    setSyncStatus('‚úÖ Photo added!');
                    setTimeout(() => setSyncStatus(''), 2000);
                } catch (error) {
                    alert('Failed to process photo: ' + error.message);
                    setSyncStatus('');
                }
            };

            const handleEditFamily = (family) => {
                setEditingFamily(family);
                setShowEditFamily(true);
            };

            const handleSaveFamily = () => {
                if (!editingFamily.headOfFamily) {
                    alert('Please enter head of family name');
                    return;
                }
                
                const updated = [...families];
                const index = updated.findIndex(f => f.familyNo === editingFamily.familyNo);
                
                if (index >= 0) {
                    updated[index] = editingFamily;
                } else {
                    updated.push(editingFamily);
                }
                
                saveChanges(updated);
                setShowEditFamily(false);
                setEditingFamily(null);
            };

            const exportEncrypted = async () => {
                try {
                    if (!password) {
                        alert('‚ùå Password not available');
                        return;
                    }
                    setSyncStatus('üì¶ Encrypting data...');
                    const encrypted = await directoryCrypto.encrypt(families, password);
                    setSyncStatus('üíæ Downloading...');
                    const success = downloadFile(encrypted, 'families.json.enc', 'text/plain');
                    if (success) {
                        setSyncStatus('‚úÖ Encrypted backup downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) {
                    setSyncStatus('‚ùå Export failed: ' + error.message);
                    alert('‚ùå Export failed: ' + error.message);
                }
            };

            const exportPlainJSON = () => {
                try {
                    setSyncStatus('üì¶ Preparing JSON export...');
                    const jsonString = JSON.stringify(families, null, 2);
                    const success = downloadFile(jsonString, 'families-backup.json', 'application/json');
                    if (success) {
                        setSyncStatus('‚úÖ Plain JSON backup downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    }
                } catch (error) {
                    setSyncStatus('‚ùå Export failed: ' + error.message);
                    alert('‚ùå Export failed: ' + error.message);
                }
            };

            const exportPDF = () => {
                try {
                    setSyncStatus('üìÑ Generating PDF...');
                    const success = exportToPDF(families);
                    if (success) {
                        setSyncStatus('‚úÖ PDF downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    } else {
                        throw new Error('PDF generation failed');
                    }
                } catch (error) {
                    setSyncStatus('‚ùå PDF export failed: ' + error.message);
                    alert('‚ùå PDF export failed: ' + error.message);
                }
            };

            const exportExcel = () => {
                try {
                    setSyncStatus('üìä Generating Excel...');
                    const success = exportToExcel(families);
                    if (success) {
                        setSyncStatus('‚úÖ Excel downloaded!');
                        setTimeout(() => setSyncStatus(''), 3000);
                    } else {
                        throw new Error('Excel export failed');
                    }
                } catch (error) {
                    setSyncStatus('‚ùå Excel export failed: ' + error.message);
                    alert('‚ùå Excel export failed: ' + error.message);
                }
            };

            const saveGitHubConfig = async () => {
                try {
                    githubSync.saveConfig(githubToken, githubRepo);
                    const result = await githubSync.testConnection();
                    alert('‚úÖ Connected successfully to ' + result.full_name);
                    setShowGitHubSettings(false);
                } catch (error) {
                    alert('‚ùå Connection failed: ' + error.message);
                }
            };

            const filteredFamilies = useMemo(() => {
                return families.filter(family => {
                    const matchesSearch = searchTerm === '' || 
                        family.headOfFamily?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        family.familyNo?.includes(searchTerm) ||
                        family.familyName?.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesPrayerGroup = selectedPrayerGroup === 'All' || 
                        family.prayerGroup === selectedPrayerGroup;
                    return matchesSearch && matchesPrayerGroup;
                });
            }, [families, searchTerm, selectedPrayerGroup]);

            const prayerGroups = useMemo(() => {
                const groups = new Set(families.map(f => f.prayerGroup).filter(Boolean));
                return ['All', ...Array.from(groups).sort()];
            }, [families]);

            // Login screen (same as before)
            if (!isUnlocked) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute top-20 left-20 w-64 h-64 bg-purple-500 rounded-full opacity-20 blur-3xl floating-orb"></div>
                        <div className="absolute bottom-20 right-20 w-96 h-96 bg-pink-500 rounded-full opacity-20 blur-3xl floating-orb" style={{animationDelay: '2s'}}></div>
                        
                        <div className="glass-effect rounded-3xl p-12 max-w-md w-full shadow-2xl relative z-10">
                            <h1 className="text-4xl font-black text-white text-center mb-2">St Thomas MTC</h1>
                            <p className="text-white/80 text-center mb-8">Salmiya, Kuwait - Church Directory</p>
                            
                            {loadingData ? (
                                <div className="text-center">
                                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-white mx-auto mb-4"></div>
                                    <p className="text-white">{syncStatus}</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <input
                                        type="password"
                                        placeholder="Enter password"
                                        value={passwordInput}
                                        onChange={(e) => setPasswordInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleUnlock()}
                                        className="w-full px-6 py-4 rounded-xl bg-white/10 border-2 border-white/30 text-white placeholder-white/50 focus:outline-none focus:border-white/60"
                                    />
                                    <button onClick={handleUnlock} className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all duration-300">
                                        üîì Unlock Directory
                                    </button>
                                    <p className="text-white/60 text-sm text-center mt-4">Password protected ‚Ä¢ Encrypted data</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Manual import screen (same as before - abbreviated)
            if (showManualImport) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl p-8 max-w-4xl w-full">
                            <h2 className="text-2xl font-bold mb-4">Manual Data Import</h2>
                            <textarea value={importJson} onChange={(e) => setImportJson(e.target.value)} placeholder='[...]' className="w-full h-96 p-4 border-2 border-gray-300 rounded-xl font-mono text-sm mb-4" />
                            <div className="flex gap-2">
                                <button onClick={handleManualImport} className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Import Data</button>
                                <button onClick={() => setShowManualImport(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold">Cancel</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main view with NEW Excel export option
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 p-4 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-96 h-96 bg-purple-500 rounded-full opacity-10 blur-3xl floating-orb"></div>
                    <div className="max-w-7xl mx-auto relative z-10">
                        {/* Header - same as before */}
                        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-3xl p-6 mb-6 shadow-2xl">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-black text-white">St Thomas MTC Salmiya, Kuwait</h1>
                                    <p className="text-white/90 mt-1">Church Directory ‚Ä¢ {families.length} Families</p>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {!isAdmin ? (
                                        <button onClick={() => setShowAdminLogin(true)} className="bg-white text-purple-700 px-4 md:px-6 py-3 rounded-xl font-bold hover:bg-white/90 transition-all text-sm md:text-base">üîê Admin</button>
                                    ) : (
                                        <>
                                            <button onClick={() => setShowSettings(true)} className="bg-white/20 text-white px-3 md:px-4 py-3 rounded-xl font-bold hover:bg-white/30 text-sm md:text-base" title="Settings">‚öôÔ∏è</button>
                                            <button onClick={() => setShowGitHubSettings(true)} className="bg-white/20 text-white px-3 md:px-4 py-3 rounded-xl font-bold hover:bg-white/30 text-sm md:text-base" title="GitHub">üîÑ</button>
                                            <button onClick={() => setShowManualImport(true)} className="bg-blue-600 text-white px-4 md:px-6 py-3 rounded-xl font-bold hover:bg-blue-700 text-sm md:text-base" title="Import">üì•</button>
                                            <button onClick={() => setShowExportOptions(true)} className="bg-yellow-600 text-white px-4 md:px-6 py-3 rounded-xl font-bold hover:bg-yellow-700 text-sm md:text-base" title="Export">üì§</button>
                                        </>
                                    )}
                                </div>
                            </div>
                            {syncStatus && <div className="mt-4 bg-white/20 rounded-xl p-3 text-white font-bold text-center">{syncStatus}</div>}
                        </div>

                        {/* Search and filters - same as before */}
                        <div className="glass-effect rounded-3xl p-6 mb-6 shadow-xl">
                            <div className="grid md:grid-cols-2 gap-4">
                                <input type="text" placeholder="üîç Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="px-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 focus:outline-none focus:border-purple-400" />
                                <select value={selectedPrayerGroup} onChange={(e) => setSelectedPrayerGroup(e.target.value)} className="px-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 focus:outline-none focus:border-purple-400">
                                    {prayerGroups.map(group => <option key={group} value={group}>{group}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* Family cards - abbreviated for space */}
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredFamilies.map(family => (
                                <div key={family.familyNo} className="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all cursor-pointer transform hover:scale-105" onClick={() => setSelectedFamily(family)}>
                                    <div className="flex gap-4 mb-3">
                                        {family.photo ? (
                                            <img src={family.photo} alt={family.headOfFamily} className="w-16 h-16 rounded-full object-cover border-2 border-white" />
                                        ) : (
                                            <div className="w-16 h-16 rounded-full bg-purple-500/50 flex items-center justify-center text-white text-2xl font-bold">
                                                {family.headOfFamily?.charAt(0) || '?'}
                                            </div>
                                        )}
                                        <div className="flex-1">
                                            <div className="text-purple-200 text-sm font-bold">#{family.familyNo}</div>
                                            <h3 className="text-white text-xl font-bold mt-1">{family.headOfFamily}</h3>
                                            <div className="bg-purple-500/50 inline-block px-3 py-1 rounded-lg text-white text-xs font-bold mt-1">{family.prayerGroup}</div>
                                        </div>
                                    </div>
                                    <div className="space-y-2 text-white/80 text-sm">
                                        {family.mobile && <div>üì± {family.mobile}</div>}
                                        {family.email && <div className="truncate">‚úâÔ∏è {family.email}</div>}
                                        <div>üë• {family.members?.length || 0} members</div>
                                    </div>
                                    {isAdmin && (
                                        <button onClick={(e) => { e.stopPropagation(); handleEditFamily(family); }} className="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-xl text-sm font-bold">‚úèÔ∏è Edit</button>
                                    )}
                                </div>
                            ))}
                        </div>

                        {filteredFamilies.length === 0 && (
                            <div className="glass-effect rounded-3xl p-12 text-center">
                                <p className="text-white/80 text-xl">{families.length === 0 ? 'No families loaded.' : 'No families found.'}</p>
                            </div>
                        )}

                        {/* Export Options Modal - WITH EXCEL! */}
                        {showExportOptions && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowExportOptions(false)}>
                                <div className="bg-white rounded-2xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                    <h2 className="text-2xl font-bold mb-4">Export Directory</h2>
                                    <p className="text-gray-600 mb-6">Choose export format:</p>
                                    
                                    <div className="space-y-3">
                                        <button onClick={() => { setShowExportOptions(false); exportExcel(); }} className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold">üìä Excel Spreadsheet (NEW!)</div>
                                                    <div className="text-sm text-green-100">3 sheets: Families, Members, Summary</div>
                                                </div>
                                                <div className="text-2xl">‚Üí</div>
                                            </div>
                                        </button>
                                        
                                        <button onClick={() => { setShowExportOptions(false); exportPDF(); }} className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold">üìÑ PDF Directory</div>
                                                    <div className="text-sm text-red-100">Printable directory</div>
                                                </div>
                                                <div className="text-2xl">‚Üí</div>
                                            </div>
                                        </button>
                                        
                                        <button onClick={() => { setShowExportOptions(false); exportEncrypted(); }} className="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold">üîê Encrypted Backup</div>
                                                    <div className="text-sm text-purple-100">Secure .enc file</div>
                                                </div>
                                                <div className="text-2xl">‚Üí</div>
                                            </div>
                                        </button>
                                        
                                        <button onClick={() => { setShowExportOptions(false); exportPlainJSON(); }} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-left px-6">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold">üìÑ Plain JSON</div>
                                                    <div className="text-sm text-blue-100">Unencrypted .json file</div>
                                                </div>
                                                <div className="text-2xl">‚Üí</div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <button onClick={() => setShowExportOptions(false)} className="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold">Cancel</button>
                                </div>
                            </div>
                        )}

                        {/* Other modals abbreviated for space - same as previous version */}
                        {/* Edit Family Modal with photo upload */}
                        {/* Admin Login Modal */}
                        {/* Settings Modal */}
                        {/* GitHub Settings Modal */}
                        {/* Family Detail Modal */}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ChurchDirectory />, document.getElementById('root'));
    </script>
</body>
</html>
